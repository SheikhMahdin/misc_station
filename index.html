<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="google-site-verification" content="UIMIT6qo5npZ-F2Oey4CBc1Vx-ekofq0YOA2L67dy9Y" />
<!-- Primary SEO Title -->
<title>Misc Station ‚Äì MISC Student Community Chat Platform</title>

<!-- Meta Description -->
<meta name="description" content="Misc Station is a MISC student community chat platform where students can connect, communicate, and build a strong academic network. Join the MISC Student Community today.">

<!-- SEO Keywords -->
<meta name="keywords" content="Misc Station, MISC Student Community, MISC Chat App, Student Community Platform, MISC Friends Chat, Misc Student Chat, chat for misc student">

<!-- Author -->
<meta name="author" content="Misc Station Team">

<!-- Robots -->
<meta name="robots" content="index, follow">

<!-- Canonical URL -->
<link rel="canonical" href="https://misc-station.vercel.app/">

<!-- Open Graph for Facebook -->
<meta property="og:type" content="website">
<meta property="og:title" content="Misc Station ‚Äì MISC Student Community Chat Platform">
<meta property="og:description" content="Join Misc Station, the MISC student community chat platform for communication and collaboration.">
<meta property="og:url" content="https://misc-station.vercel.app/">
<meta property="og:image" content="https://misc-station.vercel.app/favicon.png">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Misc Station ‚Äì MISC Student Community">
<meta name="twitter:description" content="Connect with students through Misc Station community chat platform.">
<meta name="twitter:image" content="https://misc-station.vercel.app/favicon.png">

<!-- Favicon -->
<link rel="icon" href="/favicon.png" type="image/x-icon">

<!-- Structured Data (Schema Markup) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Misc Station",
  "url": "https://misc-station.vercel.app/",
  "description": "Misc Station is a MISC student community chat platform for students to connect and communicate online."
}
</script>
<link rel="icon" type="image/png" href="favicon.png">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
  onAuthStateChanged, GoogleAuthProvider, signInWithPopup }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy,
  doc, setDoc, getDoc, getDocs, updateDoc, serverTimestamp, deleteDoc, where, arrayUnion, arrayRemove }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA9bRUWizN9nzYoxiLRw9LoVp8kSfOgqdI",
  authDomain: "misc-station.firebaseapp.com",
  projectId: "misc-station",
  storageBucket: "misc-station.firebasestorage.app",
  messagingSenderId: "362458705836",
  appId: "1:362458705836:web:3672a003d49df576cdd409"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

window._fb = { auth, db,
  createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
  onAuthStateChanged, GoogleAuthProvider, signInWithPopup,
  collection, addDoc, onSnapshot, query, orderBy,
  doc, setDoc, getDoc, getDocs, updateDoc, serverTimestamp, deleteDoc, where, arrayUnion, arrayRemove };
window.dispatchEvent(new Event('firebase-ready'));
</script>

<style>
:root{
  --bg:#07090f;--s1:#0c0f1a;--s2:#111525;--s3:#171d30;
  --bd:#1c2238;--bd2:#222a42;
  --acc:#5b8fff;--acc2:#ff5b8f;--acc3:#5bffc0;--warn:#ffc85b;
  --tx:#dde4f5;--mu:#546080;--mu2:#8a9bb8;
  --sb-w:280px;
  --safe-b:env(safe-area-inset-bottom,0px);
  --safe-t:env(safe-area-inset-top,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%;height:-webkit-fill-available;-webkit-text-size-adjust:100%}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);font-size:15px;
  height:100dvh;overflow:hidden;-webkit-tap-highlight-color:transparent;overscroll-behavior:none}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:4px}

.bg-noise{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.03;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
.glow{position:fixed;border-radius:50%;filter:blur(90px);pointer-events:none;z-index:0}
.g1{width:500px;height:500px;background:rgba(91,143,255,.07);top:-150px;left:-100px}
.g2{width:400px;height:400px;background:rgba(255,91,143,.05);bottom:-80px;right:-80px}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:999;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;
  transition:opacity .4s}
#splash.fade{opacity:0;pointer-events:none}
.splash-dot{width:10px;height:10px;border-radius:50%;background:var(--acc);
  box-shadow:0 0 14px var(--acc);animation:blink 1.2s infinite}
.splash-logo{font-family:'JetBrains Mono',monospace;font-size:13px;letter-spacing:4px;color:var(--acc);text-transform:uppercase}
@keyframes blink{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.2;transform:scale(.7)}}

/* SCREENS */
.screen{position:fixed;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;
  padding:16px;padding-top:calc(16px + var(--safe-t))}
.gone{display:none!important}
.card{background:rgba(12,15,26,.97);border:1px solid var(--bd2);border-radius:20px;
  padding:32px 28px;width:100%;max-width:420px;position:relative;z-index:1;
  backdrop-filter:blur(20px);
  box-shadow:0 32px 80px rgba(0,0,0,.55),inset 0 1px 0 rgba(255,255,255,.04);
  animation:rise .4s cubic-bezier(.16,1,.3,1) both;
  max-height:calc(100dvh - 32px);overflow-y:auto}
@keyframes rise{from{opacity:0;transform:translateY(26px) scale(.98)}to{opacity:1;transform:none}}
.brand{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.brand-dot{width:8px;height:8px;border-radius:50%;background:var(--acc);box-shadow:0 0 10px var(--acc);animation:blink 2s infinite}
.brand-tag{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--acc);text-transform:uppercase}
.card h1{font-size:24px;font-weight:800;line-height:1.2;margin-bottom:5px}
.card .sub{color:var(--mu2);font-size:13px;margin-bottom:22px;font-weight:300;line-height:1.5}
.field{margin-bottom:13px}
.field label{display:block;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--mu);margin-bottom:6px;font-family:'JetBrains Mono',monospace}
.field input,.field select{width:100%;padding:13px 14px;background:var(--s2);border:1px solid var(--bd2);
  border-radius:10px;color:var(--tx);font-family:'Outfit',sans-serif;font-size:16px;
  outline:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none;appearance:none}
.field input:focus,.field select:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(91,143,255,.11)}
.field select option{background:var(--s2)}
.btn{width:100%;padding:14px;border:none;border-radius:12px;cursor:pointer;
  font-family:'Outfit',sans-serif;font-size:15px;font-weight:700;
  background:linear-gradient(135deg,var(--acc),#2d66e0);color:#fff;
  transition:opacity .2s,transform .1s;
  box-shadow:0 4px 18px rgba(91,143,255,.28);margin-top:6px;min-height:50px;
  -webkit-appearance:none;appearance:none}
.btn:active{transform:scale(.97);opacity:.9}
.btn.ghost{background:var(--s2);color:var(--tx);border:1px solid var(--bd2);box-shadow:none}
.btn.red{background:linear-gradient(135deg,#ff3a5c,#c00030);box-shadow:0 4px 18px rgba(255,58,92,.28)}
.btn.sm{width:auto;padding:10px 18px;font-size:13px;margin-top:0;min-height:42px}
.btn.google{background:#fff;color:#1a1a1a;display:flex;align-items:center;justify-content:center;gap:10px;
  font-size:14px;margin-top:0;box-shadow:0 2px 12px rgba(0,0,0,.25);border:1px solid rgba(0,0,0,.08)}
.divider{display:flex;align-items:center;gap:12px;margin:14px 0;color:var(--mu);font-size:12px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--bd2)}
.err{color:var(--acc2);font-size:12px;margin-top:5px;display:none;font-family:'JetBrains Mono',monospace}
.lnk{text-align:center;margin-top:16px;font-size:13px;color:var(--mu2)}
.lnk a{color:var(--acc);cursor:pointer;font-weight:600}

.warn-em{font-size:36px;margin-bottom:8px}
.warn-box{background:rgba(255,200,91,.06);border:1px solid rgba(255,200,91,.2);border-radius:11px;padding:12px 14px;margin:12px 0}
.warn-box p{font-size:13px;line-height:1.7;color:var(--warn)}
.rules{list-style:none}
.rules li{display:flex;align-items:flex-start;gap:10px;font-size:13px;color:var(--mu2);padding:7px 0;border-bottom:1px solid var(--bd);line-height:1.5}
.rules li:last-child{border:none}
.rdot{width:6px;height:6px;border-radius:50%;background:var(--acc3);flex-shrink:0;margin-top:5px}
.agree-row{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--mu2);cursor:pointer;margin:14px 0 10px}
.agree-row input{accent-color:var(--acc);width:18px;height:18px;flex-shrink:0}

.alias-tip{background:rgba(91,255,192,.07);border:1px solid rgba(91,255,192,.15);border-radius:8px;padding:10px 14px;font-size:11.5px;color:var(--acc3);font-family:'JetBrains Mono',monospace;margin-bottom:12px}
.username-tip{background:rgba(91,143,255,.07);border:1px solid rgba(91,143,255,.15);border-radius:8px;padding:10px 14px;font-size:11.5px;color:var(--acc);font-family:'JetBrains Mono',monospace;margin-bottom:10px}
.col-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.cdot{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border-color .15s,transform .15s}
.cdot.on{border-color:#fff;transform:scale(1.15)}

/* APP */
#app{position:fixed;inset:0;z-index:15;display:flex;height:100dvh;overflow:hidden}

/* SIDEBAR */
.sb{width:var(--sb-w);flex-shrink:0;background:var(--s1);border-right:1px solid var(--bd);
  display:flex;flex-direction:column;height:100dvh;
  position:relative;z-index:2;transition:transform .28s cubic-bezier(.16,1,.3,1)}
.sb-top{padding:calc(13px + var(--safe-t)) 14px 13px;border-bottom:1px solid var(--bd);
  display:flex;align-items:center;justify-content:space-between;gap:8px}
.sb-logo{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--acc)}
.sb-logo small{display:block;color:var(--mu);font-size:9px;letter-spacing:1px;margin-top:1px}
.upill{display:flex;align-items:center;gap:7px;background:var(--s2);border:1px solid var(--bd2);
  border-radius:20px;padding:5px 10px 5px 5px;cursor:pointer;min-width:0;flex-shrink:0}
.upill span{font-size:12px;font-weight:600;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;flex-shrink:0;overflow:hidden}
.av img{width:100%;height:100%;object-fit:cover}
.av.lg{width:70px;height:70px;font-size:26px}
.sb-search{padding:9px 11px}
.sb-search input{width:100%;padding:9px 13px;background:var(--s2);border:1px solid var(--bd);border-radius:8px;
  color:var(--tx);font-size:15px;outline:none;font-family:'Outfit',sans-serif;-webkit-appearance:none;appearance:none}
.sb-search input:focus{border-color:var(--acc)}
.sb-sec{padding:5px 12px 3px;font-size:10px;letter-spacing:2px;color:var(--mu);font-family:'JetBrains Mono',monospace;
  text-transform:uppercase;display:flex;align-items:center;justify-content:space-between}
.sb-sec button{background:none;border:none;color:var(--mu);cursor:pointer;font-size:17px;line-height:1;
  padding:4px 6px;border-radius:4px;min-width:32px;min-height:32px}
.sb-sec button:active{color:var(--acc);background:rgba(91,143,255,.1)}
.rlist{flex:1;overflow-y:auto;padding:4px 8px;-webkit-overflow-scrolling:touch}
.ri{padding:11px;border-radius:9px;cursor:pointer;transition:background .12s;
  display:flex;align-items:center;gap:9px;margin-bottom:2px;position:relative}
.ri:active{background:var(--s2)}
.ri.active{background:var(--s3);border:1px solid var(--bd2)}
.ri-ico{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.ri-info{flex:1;min-width:0}
.ri-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:5px}
.ri-prev{font-size:11px;color:var(--mu);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.lock{font-size:10px;color:var(--mu)}
.sb-foot{padding:9px;padding-bottom:calc(9px + var(--safe-b));border-top:1px solid var(--bd)}
.sb-btn{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;cursor:pointer;
  font-size:13px;color:var(--mu2);min-height:44px}
.sb-btn:active{background:var(--s2);color:var(--acc2)}

/* CHAT */
.chat{flex:1;display:flex;flex-direction:column;height:100dvh;
  background:var(--bg);position:relative;overflow:hidden;min-width:0}
.ch-head{padding:calc(12px + var(--safe-t)) 14px 12px;border-bottom:1px solid var(--bd);
  background:var(--s1);display:flex;align-items:center;gap:10px;flex-shrink:0;min-height:58px}
.ch-ico{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.ch-info{flex:1;min-width:0}
.ch-info h2{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ch-info p{font-size:11px;color:var(--mu);font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.online{display:inline-flex;align-items:center;gap:5px}
.online::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--acc3);animation:pulse 2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.ch-acts{display:flex;gap:6px;flex-shrink:0}
.ibtn{width:36px;height:36px;border-radius:8px;border:1px solid var(--bd2);background:var(--s2);
  color:var(--mu2);cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;flex-shrink:0;-webkit-appearance:none;appearance:none}
.ibtn:active{background:var(--s3)}

.msgs{flex:1;min-height:0;overflow-y:auto;padding:14px 12px;
  display:flex;flex-direction:column;
  -webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.daydiv{text-align:center;padding:10px 0;display:flex;align-items:center;gap:10px}
.daydiv::before,.daydiv::after{content:'';flex:1;height:1px;background:var(--bd)}
.daydiv span{font-size:10px;color:var(--mu);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.mg{margin-bottom:10px}
.mrow{display:flex;align-items:flex-start;gap:8px}
.mrow.me{flex-direction:row-reverse}
.mmeta{display:flex;align-items:center;gap:7px;margin-bottom:4px}
.mrow.me .mmeta{flex-direction:row-reverse}
.malias{font-size:11.5px;font-weight:700;font-family:'JetBrains Mono',monospace}
.mtime{font-size:10px;color:var(--mu)}
.bubbles{display:flex;flex-direction:column;gap:3px;max-width:min(440px,74vw)}
.mrow.me .bubbles{align-items:flex-end}

/* ‚îÄ‚îÄ MESSAGE BUBBLE WRAP with messenger-style actions ‚îÄ‚îÄ */
.bubble-wrap{display:inline-flex;flex-direction:column;position:relative}
.mrow.me .bubble-wrap{align-items:flex-end}

/* ‚îÄ‚îÄ Simple message action button ‚îÄ‚îÄ */
.bubble-wrap{display:inline-flex;flex-direction:column;position:relative}
.mrow.me .bubble-wrap{align-items:flex-end}

/* The ‚ãØ dot shown only when msg-group is hovered */
.msg-dot{
  font-size:18px;color:var(--mu);cursor:pointer;
  padding:0 4px;line-height:1;
  opacity:0;transition:opacity .15s;
  flex-shrink:0;align-self:center;
  user-select:none;-webkit-user-select:none}
.mg:hover .msg-dot{opacity:1}
.msg-dot.open{opacity:1;color:var(--acc)}

/* The popup that appears after clicking dot */
.msg-popup{
  position:absolute;z-index:50;
  background:var(--s1);border:1px solid var(--bd2);
  border-radius:14px;padding:6px;
  box-shadow:0 8px 32px rgba(0,0,0,.55);
  display:none;flex-direction:column;gap:2px;min-width:150px;
  animation:popIn .15s cubic-bezier(.16,1,.3,1)}
.msg-popup.visible{display:flex}
/* position: below bubble, aligned to sender side */
.mrow:not(.me) .msg-popup{left:0;top:calc(100% + 4px)}
.mrow.me .msg-popup{right:0;top:calc(100% + 4px)}

/* emoji row inside popup */
.popup-emojis{display:flex;gap:2px;padding:4px 6px 6px;border-bottom:1px solid var(--bd)}
.pop-em{font-size:20px;cursor:pointer;padding:3px 4px;border-radius:8px;transition:background .1s;line-height:1}
.pop-em:hover{background:var(--s2)}

.pop-item{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:9px;
  cursor:pointer;font-size:13px;transition:background .1s}
.pop-item:hover{background:var(--s2)}
.pop-item.danger{color:#ff7a7a}
.pop-item.danger:hover{background:rgba(255,58,92,.1)}

/* bubble-row: just a flex for dot + bubble-wrap together */
.bubble-row{display:flex;align-items:center;gap:4px;position:relative}
.mrow.me .bubble-row{flex-direction:row-reverse}

/* reactions display under bubble */
@keyframes popIn{from{opacity:0;transform:scale(.8) translateY(4px)}to{opacity:1;transform:none}}
.msg-ctx-menu.visible{display:flex}
.ctx-item{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:8px;
  cursor:pointer;font-size:13px;font-weight:500;transition:background .1s;white-space:nowrap}
.ctx-item:hover,.ctx-item:active{background:var(--s2)}
.ctx-item.danger{color:#ff7a7a}
.ctx-item.danger:hover{background:rgba(255,58,92,.1)}
.ctx-ico{font-size:15px;width:18px;text-align:center}

/* ‚îÄ‚îÄ Reactions display on bubble ‚îÄ‚îÄ */
.bubble-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.reaction-chip{display:inline-flex;align-items:center;gap:4px;
  background:var(--s2);border:1px solid var(--bd2);
  border-radius:20px;padding:3px 9px;font-size:12px;
  cursor:pointer;transition:background .12s,border-color .12s}
.reaction-chip:hover{background:var(--s3);border-color:var(--acc)}
.reaction-chip.mine{background:rgba(91,143,255,.15);border-color:rgba(91,143,255,.4)}
.reaction-count{font-size:11px;color:var(--mu2);font-family:'JetBrains Mono',monospace}

/* ‚îÄ‚îÄ Reply quote ‚îÄ‚îÄ */
.reply-bar{background:rgba(91,143,255,.08);border-left:3px solid var(--acc);
  border-radius:0 8px 8px 0;padding:7px 11px;margin-bottom:6px;
  display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
.reply-bar-txt{flex:1;min-width:0}
.reply-bar-name{font-size:11px;color:var(--acc);font-weight:700;margin-bottom:2px;font-family:'JetBrains Mono',monospace}
.reply-bar-msg{font-size:12px;color:var(--mu2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.reply-bar-close{width:22px;height:22px;border:none;background:none;color:var(--mu);cursor:pointer;font-size:16px;flex-shrink:0;line-height:1}
.msg-reply-quote{background:rgba(255,255,255,.06);border-left:3px solid var(--mu);
  border-radius:0 6px 6px 0;padding:5px 9px;margin-bottom:5px;cursor:pointer}
.bubble.me .msg-reply-quote{border-left-color:rgba(255,255,255,.4);background:rgba(255,255,255,.1)}
.reply-q-name{font-size:10px;font-weight:700;margin-bottom:1px;font-family:'JetBrains Mono',monospace;opacity:.8}
.reply-q-text{font-size:12px;opacity:.7;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.bubble{padding:9px 13px;border-radius:4px 14px 14px 14px;background:var(--s2);border:1px solid var(--bd2);
  font-size:14px;line-height:1.6;word-break:break-word;width:fit-content;max-width:100%}
.bubble.me{background:linear-gradient(135deg,#2a5bd6,var(--acc));border-color:transparent;border-radius:14px 4px 14px 14px;color:#fff}
.bubble img{max-width:100%;max-height:220px;border-radius:8px;display:block;cursor:zoom-in;margin-top:4px}
.bubble video{max-width:100%;max-height:220px;border-radius:8px;display:block;margin-top:4px}
.mention{color:var(--acc3);font-weight:600;background:rgba(91,255,192,.09);border-radius:4px;padding:0 3px}
.mention.me-m{background:rgba(255,255,255,.15);color:#fff}
.sysmsg{text-align:center;font-size:11px;color:var(--mu);font-family:'JetBrains Mono',monospace;padding:5px 0}

.upload-progress{display:flex;align-items:center;gap:8px;padding:8px 12px;
  background:rgba(91,143,255,.1);border:1px solid rgba(91,143,255,.2);
  border-radius:10px;font-size:12px;color:var(--acc);margin-bottom:8px;
  font-family:'JetBrains Mono',monospace;animation:blink 1s infinite}

/* INPUT */
.inp-wrap{flex-shrink:0;background:var(--s1);border-top:1px solid var(--bd);
  padding:10px 12px;padding-bottom:calc(10px + var(--safe-b));
  position:relative;z-index:10}
.mention-dd{background:var(--s2);border:1px solid var(--bd2);border-radius:10px;
  margin-bottom:8px;overflow:hidden;display:none;max-height:150px;overflow-y:auto}
.mdd-item{padding:9px 12px;cursor:pointer;display:flex;align-items:center;gap:9px;font-size:13px;min-height:42px}
.mdd-item:active,.mdd-item.sel{background:var(--s3)}
.inp-row{display:flex;align-items:flex-end;gap:8px}
.act-btn{width:42px;height:42px;border-radius:10px;border:1px solid var(--bd2);background:var(--s2);
  color:var(--mu2);cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;-webkit-appearance:none;appearance:none}
.act-btn:active{background:var(--s3);color:var(--acc)}
#file-in{display:none}
.ibox{flex:1;background:var(--s2);border:1px solid var(--bd2);border-radius:11px;
  padding:10px 13px;color:var(--tx);font-family:'Outfit',sans-serif;font-size:16px;
  outline:none;resize:none;min-height:42px;max-height:110px;line-height:1.5;
  -webkit-appearance:none;appearance:none;display:block;width:100%;
  transition:border-color .2s,box-shadow .2s}
.ibox:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(91,143,255,.1)}
.ibox::placeholder{color:var(--mu)}
.sbtn{width:42px;height:42px;border-radius:10px;border:none;
  background:linear-gradient(135deg,var(--acc),#2d66e0);color:#fff;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;
  box-shadow:0 2px 12px rgba(91,143,255,.32);-webkit-appearance:none;appearance:none;transition:opacity .2s,transform .1s}
.sbtn:active{transform:scale(.93);opacity:.9}
.sbtn:disabled{opacity:.4;cursor:not-allowed}
.img-strip{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.ithumb{position:relative}
.ithumb img,.ithumb video{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid var(--bd2)}
.ithumb button{position:absolute;top:-5px;right:-5px;width:20px;height:20px;border-radius:50%;
  background:#ff3a5c;border:none;color:#fff;cursor:pointer;font-size:10px;
  display:flex;align-items:center;justify-content:center}

.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--mu);gap:12px}
.empty .em{font-size:52px}
.empty p{font-size:14px;text-align:center;max-width:230px;line-height:1.6}

/* MODALS */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100;
  display:flex;align-items:flex-end;justify-content:center;
  backdrop-filter:blur(4px);animation:fi .2s;padding:0}
@media(min-width:520px){.ov{align-items:center;padding:16px}}
@keyframes fi{from{opacity:0}to{opacity:1}}
.modal{background:var(--s1);border:1px solid var(--bd2);
  border-radius:20px 20px 0 0;
  padding:24px 22px;padding-bottom:calc(24px + var(--safe-b));
  width:100%;max-width:440px;
  box-shadow:0 24px 60px rgba(0,0,0,.5);
  animation:slideUp .3s cubic-bezier(.16,1,.3,1);
  max-height:90dvh;overflow-y:auto}
@media(min-width:520px){.modal{border-radius:18px;padding-bottom:24px;animation:rise .3s cubic-bezier(.16,1,.3,1)}}
@keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:none}}
.modal h3{font-size:17px;font-weight:700;margin-bottom:5px}
.modal .sub2{font-size:13px;color:var(--mu2);margin-bottom:16px;line-height:1.5}
.mbtns{display:flex;gap:9px;margin-top:14px;flex-wrap:wrap}
.mbtns .btn{margin-top:0}
.lock-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,200,91,.1);
  border:1px solid rgba(255,200,91,.2);border-radius:8px;padding:6px 12px;
  font-size:12px;color:var(--warn);font-family:'JetBrains Mono',monospace;margin-bottom:13px}

.del-icon{font-size:42px;margin-bottom:10px}
.del-warning{background:rgba(255,58,92,.06);border:1px solid rgba(255,58,92,.18);
  border-radius:10px;padding:12px 14px;margin:12px 0;font-size:13px;color:#ff9aaa;line-height:1.6}

/* PROFILE */
.profile-av-wrap{position:relative;width:fit-content;margin:0 auto 14px}
.av-edit-badge{position:absolute;bottom:0;right:0;width:24px;height:24px;border-radius:50%;
  background:var(--acc);display:flex;align-items:center;justify-content:center;
  font-size:11px;cursor:pointer;border:2px solid var(--s1)}
#av-file-in{display:none}
.uname-badge{background:rgba(91,143,255,.1);border:1px solid rgba(91,143,255,.2);border-radius:6px;
  padding:3px 10px;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--acc);
  display:inline-block;margin-top:4px}

/* MEMBERS PANEL */
.members-list{display:flex;flex-direction:column;gap:4px;max-height:300px;overflow-y:auto;margin:10px 0}
.member-row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:9px;
  background:var(--s2);border:1px solid var(--bd)}
.member-info{flex:1;min-width:0}
.member-name{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.member-role{font-size:10px;color:var(--mu);font-family:'JetBrains Mono',monospace}
.member-actions{display:flex;gap:6px;flex-shrink:0}
.mem-btn{padding:5px 10px;border-radius:6px;border:1px solid var(--bd2);background:var(--s3);
  color:var(--mu2);cursor:pointer;font-size:11px;font-family:'Outfit',sans-serif;font-weight:600}
.mem-btn.kick{border-color:rgba(255,58,92,.3);color:#ff7a7a}
.mem-btn:active{background:var(--bd2)}

/* INVITE SYSTEM */
.invite-code-box{background:var(--s2);border:1px solid var(--bd2);border-radius:10px;
  padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;
  margin:10px 0;font-family:'JetBrains Mono',monospace}
.invite-code{font-size:18px;letter-spacing:3px;font-weight:700;color:var(--acc);flex:1}
.copy-btn{padding:6px 12px;border-radius:7px;border:1px solid var(--bd2);background:var(--s3);
  color:var(--mu2);cursor:pointer;font-size:12px;font-family:'Outfit',sans-serif;font-weight:700;flex-shrink:0}
.copy-btn:active{background:var(--bd)}
.invite-tip{font-size:12px;color:var(--mu2);line-height:1.5;background:rgba(91,143,255,.06);
  border:1px solid rgba(91,143,255,.15);border-radius:8px;padding:10px 12px;margin:8px 0}
.invite-tabs{display:flex;gap:4px;margin-bottom:14px;background:var(--s2);border-radius:10px;padding:4px}
.itab{flex:1;padding:8px;border-radius:7px;border:none;background:none;color:var(--mu2);
  cursor:pointer;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;transition:all .15s}
.itab.active{background:var(--s3);color:var(--tx);border:1px solid var(--bd2)}

/* lightbox */
.lb{position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:200;
  display:flex;align-items:center;justify-content:center;cursor:zoom-out;padding:16px}
.lb img,.lb video{max-width:100%;max-height:90dvh;border-radius:10px;object-fit:contain}

/* toast */
.toast{position:fixed;bottom:calc(22px + var(--safe-b));left:50%;
  transform:translateX(-50%) translateY(16px);
  background:var(--s2);border:1px solid var(--bd2);border-radius:10px;
  padding:9px 18px;font-size:13px;z-index:300;opacity:0;
  transition:all .28s;pointer-events:none;max-width:90vw;text-align:center;
  box-shadow:0 8px 28px rgba(0,0,0,.4)}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

.sb-backdrop{display:none;position:fixed;inset:0;z-index:49;background:rgba(0,0,0,.5)}
.ham{width:38px;height:38px;border-radius:9px;border:1px solid var(--bd2);background:var(--s2);
  color:var(--tx);cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:18px;flex-shrink:0;-webkit-appearance:none;appearance:none}
.ham:active{background:var(--s3)}

/* Join via invite */
.invite-join-box{background:rgba(91,255,192,.06);border:1px solid rgba(91,255,192,.2);
  border-radius:11px;padding:14px;margin:10px 0;text-align:center}
.invite-join-box .code-preview{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:800;
  color:var(--acc3);letter-spacing:4px;margin:8px 0}

/* crop */
.crop-wrap{width:100%;height:260px;overflow:hidden;position:relative;cursor:grab;
  background:#000;border-radius:12px;user-select:none;-webkit-user-select:none}
.crop-wrap.dragging{cursor:grabbing}
#crop-canvas{display:block;width:100%;height:100%;object-fit:contain}
.crop-overlay{position:absolute;inset:0;pointer-events:none}
.crop-circle{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:200px;height:200px;border-radius:50%;
  box-shadow:0 0 0 1000px rgba(0,0,0,.55);border:2px solid rgba(255,255,255,.3)}
.crop-hint{text-align:center;font-size:12px;color:var(--mu);margin-top:8px}

/* user card in people list */
.user-card{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:9px;
  background:var(--s2);border:1px solid var(--bd);margin-bottom:6px;cursor:pointer;transition:background .12s}
.user-card:hover{background:var(--s3)}
.user-card-info{flex:1;min-width:0}
.user-card-name{font-size:13px;font-weight:700}
.user-card-sub{font-size:11px;color:var(--mu);font-family:'JetBrains Mono',monospace}
.dm-btn{padding:7px 14px;border-radius:8px;border:1px solid var(--bd2);background:var(--s3);
  color:var(--acc);cursor:pointer;font-size:12px;font-family:'Outfit',sans-serif;font-weight:700;flex-shrink:0}

/* view profile */
.view-prof-av{width:80px;height:80px;border-radius:50%;overflow:hidden;margin:0 auto 12px;
  display:flex;align-items:center;justify-content:center;font-size:30px;font-weight:700}
.view-prof-av img{width:100%;height:100%;object-fit:cover}

/* invite notification styles */
.notif-dot{position:absolute;top:-3px;right:-3px;width:9px;height:9px;border-radius:50%;
  background:#ff3a5c;border:2px solid var(--s1);display:none}
.notif-dot.visible{display:block}
.inv-notif-item{display:flex;flex-direction:column;gap:6px;padding:12px;border-radius:10px;
  background:var(--s2);border:1px solid rgba(91,143,255,.25);margin-bottom:8px}
.inv-notif-head{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600}
.inv-notif-room{color:var(--acc);font-family:'JetBrains Mono',monospace;font-size:12px;margin-left:auto}
.inv-notif-btns{display:flex;gap:7px}

/* req items */
.req-item{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:8px;background:var(--s2);border:1px solid var(--bd);margin-bottom:6px}
.req-info{flex:1;min-width:0}
.req-name{font-size:13px;font-weight:700}
.req-msg{font-size:11px;color:var(--mu2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.req-btns{display:flex;gap:6px;flex-shrink:0}
.req-yes{padding:5px 12px;border-radius:7px;border:1px solid rgba(91,255,192,.3);background:rgba(91,255,192,.08);color:var(--acc3);cursor:pointer;font-size:12px;font-weight:700}
.req-no{padding:5px 10px;border-radius:7px;border:1px solid var(--bd2);background:var(--s3);color:var(--mu);cursor:pointer;font-size:12px}
.req-empty{text-align:center;color:var(--mu);font-size:13px;padding:20px}

@media(max-width:700px){
  :root{--sb-w:82vw}
  .sb{position:fixed;top:0;left:0;height:100dvh;z-index:50;
    transform:translateX(-100%);box-shadow:8px 0 40px rgba(0,0,0,.6)}
  .sb.open{transform:translateX(0)}
  .sb-backdrop.visible{display:block}
  .bubbles{max-width:76vw}
}
@media(min-width:701px){.ham{display:none}}
</style>
</head>
<body>
<div class="bg-noise"></div>
<div class="glow g1"></div>
<div class="glow g2"></div>

<div id="splash">
  <div class="splash-dot"></div>
  <div class="splash-logo">MISC Station</div>
</div>

<!-- LOGIN -->
<div class="screen gone" id="s-login">
  <div class="card">
    <div class="brand"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Sign in</h1>
    <p class="sub">Use your school email to access the community.</p>
    <button class="btn google" onclick="doGoogle()">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Continue with Google
    </button>
    <div class="divider">or sign in with email</div>
    <div class="field"><label>Email</label><input id="l-email" type="email" placeholder="you@school.edu" autocomplete="email" inputmode="email"></div>
    <div class="field"><label>Password</label><input id="l-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
    <div class="err" id="l-err"></div>
    <button class="btn" onclick="doLogin()">Sign In</button>
    <div class="lnk">New here? <a onclick="showS('s-reg')">Create account</a></div>
    <div class="lnk" style="margin-top:8px"><a onclick="showS('s-invite-join')">üîó Join with invite code</a></div>
  </div>
</div>

<!-- REGISTER -->
<div class="screen gone" id="s-reg">
  <div class="card">
    <div class="brand"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Create account</h1>
    <p class="sub">Sign up with your school email address.</p>
    <button class="btn google" onclick="doGoogle()">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Sign up with Google
    </button>
    <div class="divider">or create with email</div>
    <div class="field"><label>Email</label><input id="r-email" type="email" placeholder="you@school.edu" autocomplete="email" inputmode="email"></div>
    <div class="field"><label>Password</label><input id="r-pass" type="password" placeholder="min 6 characters" autocomplete="new-password"></div>
    <div class="field"><label>Confirm Password</label><input id="r-pass2" type="password" placeholder="repeat password" autocomplete="new-password"></div>
    <div class="err" id="r-err"></div>
    <button class="btn" onclick="doRegister()">Create Account</button>
    <div class="lnk">Already a member? <a onclick="showS('s-login')">Sign in</a></div>
  </div>
</div>

<!-- ALIAS -->
<div class="screen gone" id="s-alias">
  <div class="card">
    <div class="brand"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Set up your profile</h1>
    <p class="sub">Choose a unique username ‚Äî your identity in the community.</p>
    <div class="alias-tip">üé≠ Your real identity stays private ‚Äî only your alias is visible.</div>
    <div class="username-tip">‚ö° Username must be unique ‚Äî no one else can have the same name.</div>
    <div class="field">
      <label>Username / Alias</label>
      <input id="a-name" type="text" placeholder="e.g. NeonWave, CosmicPanda‚Ä¶" maxlength="20"
        autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <div class="err" id="a-err" style="display:block;color:var(--mu2)">3‚Äì20 characters, letters/numbers/_ only</div>
    </div>
    <div class="field"><label>Pick a color</label><div class="col-row" id="col-row"></div></div>
    <button class="btn" onclick="saveAlias()">Continue ‚Üí</button>
  </div>
</div>

<!-- JOIN VIA INVITE (pre-login) -->
<div class="screen gone" id="s-invite-join">
  <div class="card">
    <div class="brand"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Join with Invite</h1>
    <p class="sub">Enter the invite code shared by your friend.</p>
    <div class="invite-join-box">
      <div style="font-size:13px;color:var(--mu2);margin-bottom:6px">Enter invite code below</div>
    </div>
    <div class="field">
      <label>Invite Code</label>
      <input id="pre-invite-code" type="text" placeholder="e.g. ABC123" maxlength="8"
        autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
        style="font-family:'JetBrains Mono',monospace;font-size:20px;letter-spacing:4px;text-align:center">
    </div>
    <div class="err" id="pre-invite-err"></div>
    <button class="btn" onclick="preInviteJoin()">Look Up Room</button>
    <div class="lnk"><a onclick="showS('s-login')">‚Üê Back to sign in</a></div>
  </div>
</div>

<!-- GUIDELINES -->
<div class="screen gone" id="s-warn">
  <div class="card">
    <div class="warn-em">‚ö†Ô∏è</div>
    <div class="brand" style="margin-bottom:4px"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Community Rules</h1>
    <div class="warn-box"><p>Anonymity is a privilege ‚Äî not a license to harm. Be the community you want to be part of.</p></div>
    <ul class="rules">
      <li><span class="rdot"></span>Be respectful and kind to every member at all times.</li>
      <li><span class="rdot"></span>Zero tolerance for hate speech, bullying, or discrimination.</li>
      <li><span class="rdot"></span>Do not spread false rumors or expose others' private info.</li>
      <li><span class="rdot"></span>No explicit, violent, or inappropriate content of any kind.</li>
      <li><span class="rdot"></span>Violations result in immediate and permanent ban.</li>
    </ul>
    <label class="agree-row"><input type="checkbox" id="agree-cb"> I understand and will follow these rules.</label>
    <button class="btn" onclick="enterApp()">Enter MISC Station</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="gone">
  <div class="sb-backdrop" id="sb-backdrop" onclick="closeSb()"></div>
  <div class="sb" id="sb">
    <div class="sb-top">
      <div class="sb-logo">MISC Station<small>school ¬∑ anonymous</small></div>
      <div class="upill" id="upill" onclick="openProfile()">
        <div class="av" id="sb-av"></div>
        <span id="sb-name"></span>
      </div>
    </div>
    <div class="sb-search"><input id="room-q" placeholder="üîç  Search rooms‚Ä¶" oninput="filterRooms(this.value)"></div>
    <div class="sb-sec">Channels
      <div style="display:flex;gap:4px">
        <button onclick="openM('m-people')" title="People &amp; DMs" style="font-size:14px">üë•</button>
        <button onclick="openM('m-invite-use')" title="Join with invite" style="font-size:14px">üîó</button>
        <button onclick="openCreate()" title="New Room">Ôºã</button>
      </div>
    </div>
    <div class="rlist" id="rlist"></div>
    <div class="sb-foot">
      <div class="sb-btn" style="position:relative" onclick="openMyInvites()">
        üîî &nbsp;Invitations
        <span class="notif-dot" id="inv-dot"></span>
      </div>
      <div class="sb-btn" onclick="doLogout()">‚Ü© &nbsp;Sign out</div>
    </div>
  </div>
  <div class="chat" id="chat">
    <div class="empty" id="empty-state">
      <div class="em">üí¨</div>
      <p>Pick a channel from the sidebar to start chatting.</p>
    </div>
  </div>
</div>

<!-- MODAL: create room -->
<div class="ov gone" id="m-create">
  <div class="modal">
    <h3>Create a Room</h3>
    <p class="sub2">Public rooms are open to all. Private rooms need a password.</p>
    <div class="field"><label>Room Name</label><input id="cr-n" type="text" placeholder="e.g. Study Group, Art Club‚Ä¶" maxlength="30"></div>
    <div class="field"><label>Icon (emoji)</label><input id="cr-i" type="text" placeholder="üé®" maxlength="2" style="width:70px"></div>
    <div class="field"><label>Description</label><input id="cr-d" type="text" placeholder="What's this room about?" maxlength="60"></div>
    <div class="field"><label>Room Type</label>
      <select id="cr-t" onchange="togglePw()">
        <option value="public">üåê Public ‚Äî anyone can join</option>
        <option value="private">üîí Private ‚Äî password required</option>
        <option value="invite">üîó Invite only ‚Äî invite link/code</option>
      </select>
    </div>
    <div class="field gone" id="cr-pw-f"><label>Room Password</label><input id="cr-pw" type="text" placeholder="Set join password"></div>
    <div class="err" id="cr-err"></div>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-create')">Cancel</button>
      <button class="btn" onclick="createRoom()">Create Room</button>
    </div>
  </div>
</div>

<!-- MODAL: join private -->
<div class="ov gone" id="m-join">
  <div class="modal">
    <h3>üîí Private Room</h3>
    <p class="sub2">This room requires a password set by the admin.</p>
    <div class="lock-badge">üîë Password protected</div>
    <div class="field"><label>Password</label><input id="jp-pw" type="password" placeholder="Enter room password"></div>
    <div class="err" id="jp-err">Incorrect password. Try again.</div>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-join')">Cancel</button>
      <button class="btn" onclick="joinRoom()">Join Room</button>
    </div>
    <div class="lnk" style="margin-top:12px">No password? <a onclick="openJoinReq()">Request to join ‚Üí</a></div>
  </div>
</div>

<!-- MODAL: use invite code (logged in) -->
<div class="ov gone" id="m-invite-use">
  <div class="modal">
    <h3>üîó Join with Invite Code</h3>
    <p class="sub2">Enter a room invite code to join instantly.</p>
    <div class="field">
      <label>Invite Code</label>
      <input id="inv-code-input" type="text" placeholder="e.g. ABC123" maxlength="8"
        autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
        style="font-family:'JetBrains Mono',monospace;font-size:20px;letter-spacing:4px;text-align:center">
    </div>
    <div class="err" id="inv-code-err"></div>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-invite-use')">Cancel</button>
      <button class="btn" onclick="joinViaCode()">Join Room üöÄ</button>
    </div>
  </div>
</div>

<!-- MODAL: room settings -->
<div class="ov gone" id="m-settings">
  <div class="modal">
    <h3>‚öôÔ∏è Room Settings</h3>
    <p class="sub2" id="rs-rname"></p>

    <!-- Tabs -->
    <div class="invite-tabs">
      <button class="itab active" onclick="rsTab('general',this)">General</button>
      <button class="itab" onclick="rsTab('members',this)">Members</button>
      <button class="itab" onclick="rsTab('invite',this)">Invite</button>
      <button class="itab" onclick="rsTab('requests',this)">Requests</button>
    </div>

    <!-- General -->
    <div id="rs-tab-general">
      <div class="field"><label>Room Name</label><input id="rs-n" type="text"></div>
      <div class="field"><label>Description</label><input id="rs-d" type="text"></div>
      <div class="field"><label>Password (blank = public)</label><input id="rs-pw" type="text" placeholder="New password or leave blank"></div>
      <div class="err" id="rs-err"></div>
      <div class="mbtns">
        <button class="btn red sm" onclick="confirmDeleteRoom()">üóë Delete Room</button>
        <div style="flex:1"></div>
        <button class="btn ghost sm" onclick="closeM('m-settings')">Cancel</button>
        <button class="btn sm" onclick="saveRoomSettings()">Save</button>
      </div>
    </div>

    <!-- Members -->
    <div id="rs-tab-members" class="gone">
      <div style="font-size:12px;color:var(--mu2);margin-bottom:8px">All members in this room</div>
      <div class="members-list" id="rs-members-list"></div>
      <div class="mbtns"><button class="btn ghost sm" onclick="closeM('m-settings')">Close</button></div>
    </div>

    <!-- Invite -->
    <div id="rs-tab-invite" class="gone">
      <div class="invite-tip">Share this code with people you want to invite. They can use it to join instantly (no password needed).</div>
      <div class="invite-code-box">
        <div class="invite-code" id="rs-invite-code">------</div>
        <button class="copy-btn" onclick="copyInviteCode()">üìã Copy</button>
      </div>
      <button class="btn ghost sm" style="width:100%;margin-top:4px" onclick="genNewCode()">üîÑ Generate New Code</button>
      <div style="margin:12px 0 6px;font-size:12px;font-weight:700;color:var(--mu2)">‚Äî or invite a person directly ‚Äî</div>
      <button class="btn sm" style="width:100%;margin-top:0" onclick="closeM('m-settings');openSendInvite()">üë§ Send Invite to Person üì®</button>
      <div style="margin-top:12px">
        <div style="font-size:12px;color:var(--mu2);margin-bottom:8px">Or share as full link:</div>
        <div class="invite-code-box" style="border-style:dashed">
          <div id="rs-invite-link" style="font-size:11px;color:var(--mu2);word-break:break-all;flex:1;font-family:'JetBrains Mono',monospace"></div>
          <button class="copy-btn" onclick="copyInviteLink()">üìã Copy</button>
        </div>
      </div>
      <div class="mbtns"><button class="btn ghost sm" onclick="closeM('m-settings')">Close</button></div>
    </div>

    <!-- Requests -->
    <div id="rs-tab-requests" class="gone">
      <div id="rs-reqs-wrap2">
        <div id="rs-reqs2"></div>
      </div>
      <div class="mbtns"><button class="btn ghost sm" onclick="closeM('m-settings')">Close</button></div>
    </div>
  </div>
</div>

<!-- MODAL: delete message -->
<div class="ov gone" id="m-del-msg">
  <div class="modal" style="text-align:center;max-width:360px">
    <div class="del-icon">üóëÔ∏è</div>
    <h3>Delete Message?</h3>
    <div class="del-warning">This message will be permanently deleted for everyone in this room.</div>
    <div class="mbtns" style="justify-content:center">
      <button class="btn ghost sm" onclick="closeM('m-del-msg')">Cancel</button>
      <button class="btn red sm" onclick="confirmDeleteMsg()">Yes, Delete</button>
    </div>
  </div>
</div>

<!-- MODAL: delete room -->
<div class="ov gone" id="m-del-room">
  <div class="modal" style="text-align:center;max-width:360px">
    <div class="del-icon">‚ö†Ô∏è</div>
    <h3 id="del-room-title">Delete Room?</h3>
    <div class="del-warning">All messages in this room will be permanently deleted for every member.</div>
    <div class="mbtns" style="justify-content:center">
      <button class="btn ghost sm" onclick="closeM('m-del-room')">Cancel</button>
      <button class="btn red sm" onclick="executeDeleteRoom()">Yes, Delete Room</button>
    </div>
  </div>
</div>

<!-- MODAL: profile -->
<div class="ov gone" id="m-profile">
  <div class="modal" style="text-align:center">
    <div class="profile-av-wrap">
      <div class="av lg" id="pav"></div>
      <div class="av-edit-badge" onclick="g('av-file-in').click()">üì∑</div>
      <input type="file" id="av-file-in" accept="image/*" onchange="uploadAvatar(this.files[0])">
    </div>
    <h3 id="pname"></h3>
    <div id="p-uname-badge" class="uname-badge"></div>
    <p class="sub2" id="pemail" style="margin-top:8px"></p>
    <div class="field" style="text-align:left">
      <label>Change Alias / Username</label>
      <input id="p-alias" type="text" maxlength="20" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <div class="err" id="p-alias-err"></div>
    </div>
    <div class="field" style="text-align:left"><label>Change Color</label><div class="col-row" id="p-colors"></div></div>
    <div class="field" style="text-align:left">
      <label>Caption / Bio</label>
      <input id="p-caption" type="text" maxlength="60" placeholder="e.g. Future Engineer üöÄ" autocomplete="off">
    </div>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-profile')">Cancel</button>
      <button class="btn" onclick="saveProfile()">Save Changes</button>
    </div>
  </div>
</div>

<!-- MODAL: crop -->
<div class="ov gone" id="m-crop">
  <div class="modal" style="max-width:380px">
    <h3>‚úÇÔ∏è Crop Profile Photo</h3>
    <p class="sub2">Drag to reposition ¬∑ Pinch or scroll to zoom</p>
    <div class="crop-wrap" id="crop-wrap">
      <canvas id="crop-canvas"></canvas>
      <div class="crop-overlay"><div class="crop-circle"></div></div>
    </div>
    <p class="crop-hint">Move &amp; zoom so your photo fits the circle</p>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-crop')">Cancel</button>
      <button class="btn" onclick="cropAndUpload()">Use Photo ‚úì</button>
    </div>
  </div>
</div>

<!-- MODAL: join request -->
<div class="ov gone" id="m-join-req">
  <div class="modal">
    <h3>üì® Request to Join</h3>
    <p class="sub2" id="jr-room-name">Send the admin a request to join this room.</p>
    <div class="field"><label>Message to admin (optional)</label>
      <input id="req-msg" type="text" placeholder="Hi! I'd like to join because‚Ä¶" maxlength="100" autocomplete="off">
    </div>
    <div class="err" id="req-err"></div>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-join-req')">Cancel</button>
      <button class="btn" onclick="sendJoinRequest()">Send Request üì®</button>
    </div>
  </div>
</div>

<!-- MODAL: view user profile -->
<div class="ov gone" id="m-view-prof">
  <div class="modal" style="text-align:center;max-width:320px">
    <div class="view-prof-av" id="vp-av" onclick="vpZoom()"></div>
    <h3 id="vp-name" style="margin-bottom:4px"></h3>
    <div id="vp-badge" class="uname-badge" style="margin-bottom:8px"></div>
    <p id="vp-caption" style="font-size:13px;color:var(--mu2);margin-bottom:16px;font-style:italic"></p>
    <button class="btn" onclick="startDMFromProfile()">üí¨ Send Message</button>
    <button class="btn ghost" style="margin-top:8px" onclick="closeM('m-view-prof')">Close</button>
  </div>
</div>

<!-- MODAL: people -->
<div class="ov gone" id="m-people">
  <div class="modal">
    <h3>üë• People</h3>
    <p class="sub2">Search members and start a direct message.</p>
    <div class="field" style="margin-bottom:10px">
      <input id="people-q" type="text" placeholder="Search by username‚Ä¶"
        oninput="filterPeople(this.value)" autocomplete="off" autocorrect="off" autocapitalize="off">
    </div>
    <div id="people-list" style="max-height:280px;overflow-y:auto"></div>
    <div class="mbtns"><button class="btn ghost" onclick="closeM('m-people')">Close</button></div>
  </div>
</div>

<!-- MODAL: send group invite to a person -->
<div class="ov gone" id="m-send-invite">
  <div class="modal">
    <h3>üì® Invite to Group</h3>
    <p class="sub2" id="send-inv-roomname">Invite someone to join this room.</p>
    <div class="field" style="margin-bottom:10px">
      <label>Search person to invite</label>
      <input id="send-inv-q" type="text" placeholder="Search by username‚Ä¶"
        oninput="filterInvitePeople(this.value)" autocomplete="off" autocorrect="off" autocapitalize="off">
    </div>
    <div id="send-inv-list" style="max-height:260px;overflow-y:auto"></div>
    <div class="err" id="send-inv-err"></div>
    <div class="mbtns"><button class="btn ghost" onclick="closeM('m-send-invite')">Close</button></div>
  </div>
</div>

<!-- MODAL: my invitations (inbox) -->
<div class="ov gone" id="m-my-invites">
  <div class="modal">
    <h3>üì¨ Group Invitations</h3>
    <p class="sub2">Invitations sent to you to join rooms.</p>
    <div id="my-invites-list" style="max-height:320px;overflow-y:auto"></div>
    <div class="mbtns"><button class="btn ghost" onclick="closeM('m-my-invites')">Close</button></div>
  </div>
</div>
<div class="lb gone" id="lb" onclick="this.classList.add('gone')">
  <img id="lb-img" alt="" style="display:none">
  <video id="lb-vid" controls style="display:none"></video>
</div>
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG ‚Äî paste your ImgBB key here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IMGBB_API_KEY = 'f8150fd459c0b9ea76bdcae5588f2e0f';

let fb, CU, CP, CR, CRD;
let unsubM=null, unsubR=null;
let allUsers={};
let pendImgs=[]; // {file, isVideo, dataURL}
let joinTarget=null;
let mentionActive=false, mentionQuery='', mentionIdx=0;
let lastRooms=[];
let pendingDeleteMsgId=null;
let replyTo=null; // {id, alias, text}
let uploading=false;
let touchStartX=0, touchStartY=0, touchStartTime=0;

const COLORS=['#5b8fff','#ff5b8f','#5bffc0','#ffc85b','#c05bff','#ff8c5b','#5beaff','#ff5b5b'];
let selColor=COLORS[0], profColor=COLORS[0];
const RULES_KEY='misc_rules_v3';
const QUICK_REACTS=['‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üò°','üëç','üëé','üî•'];

const DEFAULT_ROOMS=[
  {id:'general',  name:'General',      icon:'üè´',desc:'School-wide chat',       type:'public',adminUid:null},
  {id:'homework', name:'Homework Help', icon:'üìö',desc:'Get help with homework', type:'public',adminUid:null},
  {id:'memes',    name:'Memes & Fun',   icon:'üòÇ',desc:'Laugh a little',         type:'public',adminUid:null},
  {id:'events',   name:'Events',        icon:'üéâ',desc:'Events & plans',         type:'public',adminUid:null},
  {id:'sports',   name:'Sports',        icon:'‚öΩ',desc:'Sports talk',            type:'public',adminUid:null},
  {id:'advice',   name:'Advice Box',    icon:'üí≠',desc:'Anonymous advice',       type:'public',adminUid:null},
];

// ‚îÄ‚îÄ IMGBB UPLOAD (image + video) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function imgbbUpload(file) {
  const base64 = await new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.onerror=()=>rej(new Error('Failed to read file'));
    r.readAsDataURL(file);
  });
  const fd=new FormData();
  fd.append('key', IMGBB_API_KEY);
  fd.append('image', base64);
  const resp=await fetch('https://api.imgbb.com/1/upload',{method:'POST',body:fd});
  const json=await resp.json();
  if(!json.success) throw new Error(json.error?.message||'ImgBB upload failed');
  return json.data.url;
}

// Video upload: uses file.io (free, CORS-friendly, no account needed, files expire after 1 download by default ‚Äî use &expires=1y)
// For bigger videos we try transfer.sh as fallback
async function videoUpload(file) {
  if(file.size > 100*1024*1024) throw new Error('Video too large. Max 100MB for free upload.');
  // Try file.io first
  try {
    const fd=new FormData();
    fd.append('file', file);
    fd.append('expires','1y');
    fd.append('maxDownloads','1000');
    const resp=await fetch('https://file.io/?expires=1y', {method:'POST', body:fd});
    const json=await resp.json();
    if(json.success && json.link) return json.link;
    throw new Error('file.io failed');
  } catch(e1) {
    // Fallback: transfer.sh
    try {
      const resp=await fetch(`https://transfer.sh/${encodeURIComponent(file.name)}`, {
        method:'PUT', body:file,
        headers:{'Max-Days':'30'}
      });
      if(!resp.ok) throw new Error('transfer.sh failed');
      const url=(await resp.text()).trim();
      if(url.startsWith('http')) return url;
      throw new Error('Bad URL');
    } catch(e2) {
      throw new Error('Video upload failed. Both file.io and transfer.sh failed. Try a smaller file or different network.');
    }
  }
}

window.addEventListener('firebase-ready',()=>{
  fb=window._fb;
  buildColPicker('col-row',c=>selColor=c);
  seedDefaults();
  fb.onAuthStateChanged(fb.auth,async u=>{
    if(u){
      CU=u;
      const snap=await fb.getDoc(fb.doc(fb.db,'users',u.uid));
      if(snap.exists()&&snap.data().alias){
        CP=snap.data();
        const rulesOk=localStorage.getItem(RULES_KEY+'_'+u.uid);
        hideSplash();
        if(rulesOk) launchApp();
        else showS('s-warn');
      } else {
        if(u.displayName) g('a-name').value=u.displayName.replace(/\s+/g,'').slice(0,20);
        hideSplash();
        showS('s-alias');
      }
    } else {
      CU=null; CP=null;
      hideSplash();
      showS('s-login');
    }
  });
  initSwipe();
  initKeyboard();
  // Close any open ctx menu on outside click
  document.addEventListener('click',()=>{
    if(activePopup){closePopup(activePopup,activeDot);}
  });
});

function hideSplash(){
  const s=g('splash'); s.classList.add('fade');
  setTimeout(()=>s.classList.add('gone'),420);
}

function initSwipe(){
  document.addEventListener('touchstart',e=>{
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
    touchStartTime=Date.now();
  },{passive:true});
  document.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-touchStartX;
    const dy=Math.abs(e.changedTouches[0].clientY-touchStartY);
    const dt=Date.now()-touchStartTime;
    if(dy>Math.abs(dx)*0.75) return;
    const ok=(dt<400&&Math.abs(dx)>35)||(Math.abs(dx)>70);
    if(!ok) return;
    const sb=g('sb');if(!sb)return;
    if(dx>0&&!sb.classList.contains('open')) openSb();
    if(dx<0&&sb.classList.contains('open')) closeSb();
  },{passive:true});
}

function initKeyboard(){
  if(!('visualViewport' in window)) return;
  const vv=window.visualViewport;
  let lastH=vv.height;
  function onVVChange(){
    const app=g('app'); if(!app)return;
    app.style.height=vv.height+'px';
    app.style.top=vv.offsetTop+'px';
    app.style.position='fixed';
    app.style.left='0'; app.style.right='0';
    if(Math.abs(vv.height-lastH)>50){
      lastH=vv.height;
      const ml=g('mlist');
      if(ml) setTimeout(()=>{ml.scrollTop=ml.scrollHeight;},80);
    }
  }
  vv.addEventListener('resize',onVVChange,{passive:true});
  vv.addEventListener('scroll',onVVChange,{passive:true});
  onVVChange();
}

function openSb(){g('sb').classList.add('open');g('sb-backdrop').classList.add('visible');}
function closeSb(){g('sb').classList.remove('open');g('sb-backdrop').classList.remove('visible');}
function showS(id){document.querySelectorAll('.screen').forEach(s=>s.classList.add('gone'));g(id)?.classList.remove('gone');}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function doLogin(){
  try{await fb.signInWithEmailAndPassword(fb.auth,v('l-email'),v('l-pass'));}
  catch(e){showErr('l-err',fe(e.code));}
}
async function doRegister(){
  const p=v('r-pass'),p2=v('r-pass2');
  if(p!==p2) return showErr('r-err','Passwords do not match.');
  if(p.length<6) return showErr('r-err','Password must be at least 6 characters.');
  try{await fb.createUserWithEmailAndPassword(fb.auth,v('r-email'),p);}
  catch(e){showErr('r-err',fe(e.code));}
}
async function doGoogle(){
  try{
    const provider=new fb.GoogleAuthProvider();
    await fb.signInWithPopup(fb.auth,provider);
  }catch(e){
    if(e.code!=='auth/popup-closed-by-user') toast(fe(e.code));
  }
}
async function saveAlias(){
  const name=v('a-name');
  if(!/^[\w]{3,20}$/.test(name)) return showErr('a-err','3‚Äì20 characters, letters/numbers/_ only.');
  const q=fb.query(fb.collection(fb.db,'users'),fb.where('alias','==',name));
  const snap=await fb.getDocs(q);
  if(!snap.empty&&snap.docs[0].id!==CU.uid) return showErr('a-err','Username already taken. Choose another.');
  const profile={alias:name,color:selColor,email:CU.email||'',uid:CU.uid,photoURL:CU.photoURL||''};
  await fb.setDoc(fb.doc(fb.db,'users',CU.uid),profile);
  CP=profile; showS('s-warn');
}
function enterApp(){
  if(!g('agree-cb').checked) return toast('Please agree to the community rules.');
  localStorage.setItem(RULES_KEY+'_'+CU.uid,'1');
  launchApp();
}
async function doLogout(){
  if(unsubM)unsubM();
  if(unsubR)unsubR();
  CR=null; CRD=null;
  await fb.signOut(fb.auth);
}

async function launchApp(){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('gone'));
  g('app').classList.remove('gone');
  updatePill();
  startRoomSub();
  await loadUsers();
  subscribeInvites();
  if(window.innerWidth<=700) openSb();
}
function updatePill(){
  const av=g('sb-av');
  if(CP.photoURL){av.innerHTML=`<img src="${CP.photoURL}" alt="">`;av.style.background='';}
  else{av.innerHTML='';av.textContent=CP.alias[0].toUpperCase();av.style.background=CP.color;}
  g('sb-name').textContent=CP.alias;
}
async function loadUsers(){
  const snap=await fb.getDocs(fb.collection(fb.db,'users'));
  snap.forEach(d=>allUsers[d.id]=d.data());
}

async function seedDefaults(){
  for(const r of DEFAULT_ROOMS){
    const ref=fb.doc(fb.db,'rooms',r.id);
    const s=await fb.getDoc(ref);
    if(!s.exists()) await fb.setDoc(ref,{...r,createdAt:fb.serverTimestamp()});
  }
}

// ‚îÄ‚îÄ ROOMS ‚îÄ‚îÄ
function startRoomSub(){
  const q=fb.query(fb.collection(fb.db,'rooms'),fb.orderBy('createdAt','asc'));
  unsubR=fb.onSnapshot(q,snap=>{
    lastRooms=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderRooms(lastRooms);
  });
}
function renderRooms(rooms){
  const list=g('rlist'); list.innerHTML='';
  rooms.forEach(r=>{
    // For DMs: only show if current user is a member
    if(r.type==='dm'){
      if(!r.members||!r.members.includes(CU.uid)) return;
      // Show the other person's name
      r={...r, name: r.nameFor?.[CU.uid]||r.name};
    }
    const div=document.createElement('div');
    div.className='ri'+(CR===r.id?' active':'');
    div.dataset.id=r.id;
    const typeIcon=r.type==='private'?'üîí':r.type==='invite'?'üîó':r.type==='dm'?'üí¨':'';
    div.innerHTML=`
      <div class="ri-ico" style="background:${rbg(r.id)}">${r.icon||'#'}</div>
      <div class="ri-info">
        <div class="ri-name">${esc(r.name)} ${typeIcon?`<span class="lock">${typeIcon}</span>`:''}</div>
        <div class="ri-prev">${esc(r.desc||'')}</div>
      </div>`;
    div.onclick=()=>{tryJoin(r);closeSb();};
    list.appendChild(div);
  });
}
function filterRooms(q){
  renderRooms(q?lastRooms.filter(r=>r.name.toLowerCase().includes(q.toLowerCase())):lastRooms);
}

// ‚îÄ‚îÄ JOIN ‚îÄ‚îÄ
async function tryJoin(r){
  if(r.type==='private'){
    if(r.adminUid===CU?.uid){openRoom(r);return;}
    const ms=await fb.getDoc(fb.doc(fb.db,'rooms',r.id,'members',CU.uid));
    if(!ms.exists()){joinTarget=r;g('jp-pw').value='';g('jp-err').style.display='none';openM('m-join');return;}
  }
  if(r.type==='invite'){
    if(r.adminUid===CU?.uid){openRoom(r);return;}
    const ms=await fb.getDoc(fb.doc(fb.db,'rooms',r.id,'members',CU.uid));
    if(!ms.exists()){joinTarget=r;toast('This is an invite-only room. Get an invite code from the admin.');return;}
  }
  openRoom(r);
}
async function joinRoom(){
  if(v('jp-pw')!==joinTarget.password){g('jp-err').style.display='block';return;}
  await fb.setDoc(fb.doc(fb.db,'rooms',joinTarget.id,'members',CU.uid),{joinedAt:fb.serverTimestamp()});
  closeM('m-join'); openRoom(joinTarget); closeSb(); joinTarget=null;
}

// ‚îÄ‚îÄ JOIN VIA INVITE CODE ‚îÄ‚îÄ
async function joinViaCode(){
  const code=g('inv-code-input').value.trim().toUpperCase();
  if(!code||code.length<4){showErr('inv-code-err','Enter a valid invite code.');return;}
  await doJoinViaCode(code,'inv-code-err');
}
async function preInviteJoin(){
  const code=g('pre-invite-code').value.trim().toUpperCase();
  if(!code||code.length<4){showErr('pre-invite-err','Enter a valid invite code.');return;}
  // They may not be logged in
  if(!CU){toast('Please sign in first, then use the invite code.');showS('s-login');return;}
  await doJoinViaCode(code,'pre-invite-err');
}
async function doJoinViaCode(code,errId){
  const q=fb.query(fb.collection(fb.db,'rooms'),fb.where('inviteCode','==',code));
  const snap=await fb.getDocs(q);
  if(snap.empty){showErr(errId,'Invalid invite code. Please check and try again.');return;}
  const roomDoc=snap.docs[0];
  const roomData={id:roomDoc.id,...roomDoc.data()};
  await fb.setDoc(fb.doc(fb.db,'rooms',roomDoc.id,'members',CU.uid),{joinedAt:fb.serverTimestamp()});
  closeM('m-invite-use');
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('gone'));
  toast(`Joined "${roomData.name}" via invite! üéâ`);
  openRoom(roomData);
  closeSb();
}

// ‚îÄ‚îÄ OPEN ROOM ‚îÄ‚îÄ
function openRoom(r){
  CR=r.id; CRD=r;
  if(unsubM)unsubM();
  document.querySelectorAll('.ri').forEach(x=>x.classList.toggle('active',x.dataset.id===r.id));
  renderChat(r);
  startMsgSub(r.id);
}

function renderChat(r){
  const isAdmin=r.adminUid===CU?.uid;
  const isDM=r.type==='dm';
  // For DM: find the other user's data for header display
  let dmOtherUser=null;
  if(isDM&&r.members){
    const otherId=r.members.find(id=>id!==CU.uid);
    dmOtherUser=allUsers[otherId]||null;
  }
  const headerIcon=isDM&&dmOtherUser
    ? (dmOtherUser.photoURL
        ? `<div class="ch-ico" style="cursor:pointer;overflow:hidden;border-radius:50%" onclick='viewUserProfile("${dmOtherUser.uid}","${dmOtherUser.alias}","${dmOtherUser.color}","${dmOtherUser.photoURL||''}")'><img src="${dmOtherUser.photoURL}" style="width:100%;height:100%;object-fit:cover" alt=""></div>`
        : `<div class="ch-ico" style="cursor:pointer;background:${dmOtherUser.color};border-radius:50%;font-size:16px;font-weight:700;color:#fff" onclick='viewUserProfile("${dmOtherUser.uid}","${dmOtherUser.alias}","${dmOtherUser.color}","")'>${dmOtherUser.alias[0].toUpperCase()}</div>`)
    : `<div class="ch-ico" style="background:${rbg(r.id)}">${r.icon||'#'}</div>`;
  g('chat').innerHTML=`
    <div class="ch-head">
      <button class="ham" onclick="openSb()">‚ò∞</button>
      ${headerIcon}
      <div class="ch-info">
        <h2>${esc(r.name)} ${r.type==='private'?'üîí':r.type==='invite'?'üîó':''}</h2>
        <p><span class="online"></span>${isDM?'Direct message':'anonymous ¬∑ '+esc(r.desc||'')}</p>
      </div>
      <div class="ch-acts">
        ${!isDM?`<button class="ibtn" onclick="openM('m-room-members')" title="Members">üë•</button>`:''}
        ${isAdmin?`<button class="ibtn" onclick="openSettings()">‚öôÔ∏è</button>`:''}
      </div>
    </div>
    <div class="msgs" id="mlist"></div>
    <div class="inp-wrap" id="inp-wrap">
      <div id="reply-bar" style="display:none" class="reply-bar">
        <div class="reply-bar-txt">
          <div class="reply-bar-name" id="reply-bar-name"></div>
          <div class="reply-bar-msg" id="reply-bar-msg"></div>
        </div>
        <button class="reply-bar-close" onclick="clearReply()">‚úï</button>
      </div>
      <div class="img-strip" id="img-strip"></div>
      <div id="upload-indicator" style="display:none" class="upload-progress">‚è≥ Uploading media‚Ä¶</div>
      <div class="mention-dd" id="mdd"></div>
      <div class="inp-row">
        <button class="act-btn" onclick="g('file-in').click()" title="Image/Video">üñº</button>
        <input type="file" id="file-in" accept="image/*,video/*" multiple onchange="handleImgs(this.files)">
        <textarea class="ibox" id="ibox"
          placeholder="Message #${r.name.toLowerCase()}‚Ä¶ (@ mention)"
          rows="1" onkeydown="hKey(event)" oninput="hInput(this)"></textarea>
        <button class="sbtn" id="send-btn" onclick="sendMsg()">‚û§</button>
      </div>
    </div>`;
  loadRoomMembersModal(r.id);
}

// ‚îÄ‚îÄ ROOM MEMBERS MODAL (dynamic) ‚îÄ‚îÄ
function ensureRoomMembersModal(){
  if(g('m-room-members')) return;
  const div=document.createElement('div');
  div.className='ov gone'; div.id='m-room-members';
  div.innerHTML=`
    <div class="modal">
      <h3>üë• Room Members</h3>
      <p class="sub2" id="room-members-count"></p>
      <div class="members-list" id="room-members-list"></div>
      <div class="mbtns">
        <button class="btn red sm" id="leave-room-btn" onclick="leaveRoom()" style="display:none">üö™ Leave Group</button>
        <button class="btn ghost" onclick="closeM('m-room-members')">Close</button>
      </div>
    </div>`;
  div.addEventListener('click',e=>{if(e.target===div)div.classList.add('gone');});
  document.body.appendChild(div);
}
async function loadRoomMembersModal(roomId){
  ensureRoomMembersModal();
}
window._openRoomMembers=async function(){
  ensureRoomMembersModal();
  const list=g('room-members-list');
  list.innerHTML='<div style="color:var(--mu);font-size:13px;text-align:center;padding:16px">Loading‚Ä¶</div>';
  openM('m-room-members');
  // Load members subcollection
  const snap=await fb.getDocs(fb.collection(fb.db,'rooms',CR,'members'));
  const memberIds=snap.docs.map(d=>d.id);
  // Also include admin if not in members list
  if(CRD.adminUid&&!memberIds.includes(CRD.adminUid)) memberIds.unshift(CRD.adminUid);
  // Load user data for each
  const members=[];
  for(const uid of memberIds){
    if(allUsers[uid]) members.push(allUsers[uid]);
    else{
      const u=await fb.getDoc(fb.doc(fb.db,'users',uid));
      if(u.exists()){allUsers[uid]=u.data();members.push(u.data());}
    }
  }
  g('room-members-count').textContent=`${members.length} member${members.length!==1?'s':''}`;
  // Show leave button only for non-admins in group rooms (not DMs)
  const leaveBtn=g('leave-room-btn');
  if(leaveBtn){
    const isAdmin=CRD&&CRD.adminUid===CU.uid;
    const isDM=CRD&&CRD.type==='dm';
    leaveBtn.style.display=(!isAdmin&&!isDM)?'':'none';
  }
  if(!members.length){list.innerHTML='<div style="color:var(--mu);text-align:center;padding:16px">No members found.</div>';return;}
  members.forEach(u=>{
    if(!u) return;
    const isAdmin=u.uid===CRD?.adminUid;
    const isSelf=u.uid===CU.uid;
    const row=document.createElement('div');row.className='member-row';
    const av=document.createElement('div');av.className='av';av.style.cssText='width:32px;height:32px;font-size:12px;flex-shrink:0';
    if(u.photoURL)av.innerHTML=`<img src="${u.photoURL}" alt="">`;
    else{av.style.background=u.color||'var(--acc)';av.textContent=(u.alias||'?')[0].toUpperCase();}
    const info=document.createElement('div');info.className='member-info';
    info.innerHTML=`<div class="member-name" style="color:${u.color||'var(--tx)'}">${esc(u.alias)}</div>
      <div class="member-role">${isAdmin?'üëë Admin':isSelf?'you':''}</div>`;
    row.appendChild(av); row.appendChild(info);
    // DM button
    if(!isSelf){
      const btn=document.createElement('button');btn.className='mem-btn';btn.textContent='üí¨';
      btn.onclick=e=>{e.stopPropagation();closeM('m-room-members');openDM(u);};
      row.appendChild(btn);
    }
    // Kick button (admin only, not self)
    if(CRD&&CRD.adminUid===CU.uid&&!isAdmin&&!isSelf){
      const kick=document.createElement('button');kick.className='mem-btn kick';kick.textContent='Kick';
      kick.onclick=async e=>{
        e.stopPropagation();
        if(!confirm(`Kick ${u.alias} from this room?`)) return;
        await fb.deleteDoc(fb.doc(fb.db,'rooms',CR,'members',u.uid));
        row.remove();
        toast(`${u.alias} removed.`);
      };
      row.appendChild(kick);
    }
    list.appendChild(row);
  });
};
// Override openM for room-members
const _origOpenM_members=window.openM||(id=>g(id)?.classList.remove('gone'));

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ
function startMsgSub(rid){
  // For DMs, we filter by checking if both UIDs are in DM members
  const q=fb.query(fb.collection(fb.db,'rooms',rid,'messages'),fb.orderBy('ts','asc'));
  unsubM=fb.onSnapshot(q,snap=>{
    const msgs=snap.docs.map(d=>({id:d.id,...d.data()}));
    // For DMs: show all since only the two members exist
    renderMsgs(msgs);
  });
}

function renderMsgs(msgs){
  const list=g('mlist'); if(!list)return;
  const atBot=list.scrollHeight-list.scrollTop-list.clientHeight<120;
  list.innerHTML='';
  let lastDate='', lastUid='';
  msgs.forEach(m=>{
    const d=m.ts?new Date(m.ts.seconds*1000):new Date();
    const ds=d.toLocaleDateString([],{weekday:'short',month:'short',day:'numeric'});
    if(ds!==lastDate){
      const dd=document.createElement('div');dd.className='daydiv';
      dd.innerHTML=`<span>${ds}</span>`;list.appendChild(dd);
      lastDate=ds; lastUid='';
    }
    if(m.type==='system'){
      const s=document.createElement('div');s.className='sysmsg';s.textContent=m.text;list.appendChild(s);return;
    }
    const isMine=m.uid===CU.uid;
    const newGrp=m.uid!==lastUid; lastUid=m.uid;
    if(newGrp){
      const mg=document.createElement('div');mg.className='mg';
      const row=document.createElement('div');row.className='mrow'+(isMine?' me':'');
      const av=document.createElement('div');av.className='av';av.style.cursor='pointer';
      if(m.photoURL)av.innerHTML=`<img src="${m.photoURL}" alt="">`;
      else{av.style.background=m.color;av.textContent=(m.alias||'?')[0].toUpperCase();}
      if(!isMine) av.onclick=()=>viewUserProfile(m.uid,m.alias,m.color,m.photoURL||'');
      else if(CRD&&CRD.type==='dm') av.onclick=()=>openProfile();
      const side=document.createElement('div');
      side.style.cssText='flex:1;display:flex;flex-direction:column;min-width:0'+(isMine?';align-items:flex-end':'');
      const meta=document.createElement('div');meta.className='mmeta';
      meta.innerHTML=`<span class="malias" style="color:${m.color}">${esc(m.alias)}</span><span class="mtime">${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
      const bubbles=document.createElement('div');bubbles.className='bubbles';
      bubbles.appendChild(mkBubble(m,isMine,row));
      side.appendChild(meta); side.appendChild(bubbles);
      row.appendChild(av); row.appendChild(side);
      mg.appendChild(row); list.appendChild(mg);
    } else {
      const lastMg=list.lastElementChild;
      const bubbles=lastMg?.querySelector('.bubbles');
      const row=lastMg?.querySelector('.mrow');
      if(bubbles&&row) bubbles.appendChild(mkBubble(m,isMine,row));
    }
  });
  if(atBot) list.scrollTop=list.scrollHeight;
}

function mkBubble(m,isMine,rowEl){
  // outerWrap: column flex (reply-quote + bubble-row + reactions)
  const outerWrap=document.createElement('div');
  outerWrap.style.cssText='display:inline-flex;flex-direction:column;'+(isMine?'align-items:flex-end':'align-items:flex-start');

  // Reply quote
  if(m.replyTo){
    const q=document.createElement('div');q.className='msg-reply-quote';
    q.innerHTML=`<div class="reply-q-name" style="color:${esc(m.replyTo.color||'#8a9bb8')}">${esc(m.replyTo.alias)}</div><div class="reply-q-text">${esc(m.replyTo.text||'media')}</div>`;
    outerWrap.appendChild(q);
  }

  // bubble-row
  const bubbleRow=document.createElement('div');bubbleRow.className='bubble-row';

  // Bubble
  const wrap=document.createElement('div');wrap.className='bubble-wrap';
  const b=document.createElement('div');b.className='bubble'+(isMine?' me':'');
  if(m.videoUrl){
    const vid=document.createElement('video');vid.src=m.videoUrl;vid.controls=true;
    vid.style.cssText='max-width:100%;max-height:220px;border-radius:8px;display:block;margin-top:4px';
    vid.onclick=e=>e.stopPropagation();
    b.appendChild(vid);
  }
  if(m.imageUrl){
    const img=document.createElement('img');img.src=m.imageUrl;img.alt='';
    img.onclick=e=>{e.stopPropagation();openLightbox(m.imageUrl,false);};
    b.appendChild(img);
  }
  if(m.text){
    const sp=document.createElement('span');sp.innerHTML=fmtText(m.text,isMine);b.appendChild(sp);
  }
  wrap.appendChild(b);

  // Dot button
  const dot=document.createElement('span');dot.className='msg-dot';dot.textContent='‚Ä¢‚Ä¢‚Ä¢';
  dot.onclick=e=>{e.stopPropagation();toggleMsgPopup(popup,dot);};

  // Unified popup (emojis + reply + delete)
  const popup=document.createElement('div');popup.className='msg-popup';
  const emojiRow=document.createElement('div');emojiRow.className='popup-emojis';
  QUICK_REACTS.forEach(em=>{
    const s=document.createElement('span');s.className='pop-em';s.textContent=em;
    s.onclick=e=>{e.stopPropagation();toggleReact(m.id,em);closePopup(popup,dot);};
    emojiRow.appendChild(s);
  });
  popup.appendChild(emojiRow);
  const replyItem=document.createElement('div');replyItem.className='pop-item';
  replyItem.innerHTML='\u21A9\uFE0F  Reply';
  replyItem.onclick=e=>{e.stopPropagation();setReply(m);closePopup(popup,dot);};
  popup.appendChild(replyItem);
  if(isMine){
    const delItem=document.createElement('div');delItem.className='pop-item danger';
    delItem.innerHTML='\uD83D\uDDD1\uFE0F  Delete';
    delItem.onclick=e=>{e.stopPropagation();askDeleteMsg(m.id);closePopup(popup,dot);};
    popup.appendChild(delItem);
  }
  wrap.appendChild(popup);

  if(!isMine){bubbleRow.appendChild(dot);bubbleRow.appendChild(wrap);}
  else{bubbleRow.appendChild(wrap);bubbleRow.appendChild(dot);}
  outerWrap.appendChild(bubbleRow);

  const reactDiv=document.createElement('div');reactDiv.className='bubble-reactions';
  renderReactions(reactDiv,m,isMine);
  outerWrap.appendChild(reactDiv);

  // Long press on mobile
  let tt;
  outerWrap.addEventListener('touchstart',()=>{tt=setTimeout(()=>toggleMsgPopup(popup,dot),400);},{passive:true});
  outerWrap.addEventListener('touchend',()=>clearTimeout(tt),{passive:true});
  outerWrap.addEventListener('touchmove',()=>clearTimeout(tt),{passive:true});

  return outerWrap;
}

let activePopup=null,activeDot=null;
function toggleMsgPopup(popup,dot){
  if(activePopup&&activePopup!==popup)closePopup(activePopup,activeDot);
  const isOpen=popup.classList.contains('visible');
  closePopup(popup,dot);
  if(!isOpen){popup.classList.add('visible');dot.classList.add('open');activePopup=popup;activeDot=dot;}
}
function closePopup(popup,dot){
  popup?.classList.remove('visible');dot?.classList.remove('open');
  if(activePopup===popup){activePopup=null;activeDot=null;}
}
function toggleMsgMenu(){}
function closeCtxMenu(){}

function openLightbox(src, isVideo){
  const img=g('lb-img'), vid=g('lb-vid');
  if(isVideo){img.style.display='none';vid.style.display='';vid.src=src;}
  else{vid.style.display='none';img.style.display='';img.src=src;}
  g('lb').classList.remove('gone');
}

// ‚îÄ‚îÄ REACTIONS ‚îÄ‚îÄ
async function toggleReact(msgId,emoji){
  if(!CR||!msgId) return;
  const ref=fb.doc(fb.db,'rooms',CR,'messages',msgId);
  const snap=await fb.getDoc(ref);
  if(!snap.exists()) return;
  const data=snap.data();
  const reactions=data.reactions||{};
  const who=reactions[emoji]||[];
  if(who.includes(CU.uid)){
    reactions[emoji]=who.filter(u=>u!==CU.uid);
    if(!reactions[emoji].length) delete reactions[emoji];
  } else {
    reactions[emoji]=[...who,CU.uid];
  }
  await fb.updateDoc(ref,{reactions});
}
function renderReactions(container,m,isMine){
  container.innerHTML='';
  const reactions=m.reactions||{};
  Object.entries(reactions).forEach(([emoji,who])=>{
    if(!who.length) return;
    const chip=document.createElement('div');
    chip.className='reaction-chip'+(who.includes(CU.uid)?' mine':'');
    chip.innerHTML=`${emoji}<span class="reaction-count">${who.length}</span>`;
    chip.onclick=e=>{e.stopPropagation();toggleReact(m.id,emoji);};
    container.appendChild(chip);
  });
}

// ‚îÄ‚îÄ REPLY ‚îÄ‚îÄ
function setReply(m){
  replyTo={id:m.id,alias:m.alias,color:m.color,text:m.text||'üìé media'};
  const rb=g('reply-bar');
  if(!rb) return;
  rb.style.display='flex';
  g('reply-bar-name').textContent=m.alias;
  g('reply-bar-name').style.color=m.color;
  g('reply-bar-msg').textContent=m.text||'üìé media';
  g('ibox')?.focus();
}
function clearReply(){
  replyTo=null;
  const rb=g('reply-bar');
  if(rb) rb.style.display='none';
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ
function askDeleteMsg(id){pendingDeleteMsgId=id;openM('m-del-msg');}
async function confirmDeleteMsg(){
  if(!pendingDeleteMsgId||!CR)return;
  closeM('m-del-msg');
  await fb.deleteDoc(fb.doc(fb.db,'rooms',CR,'messages',pendingDeleteMsgId));
  pendingDeleteMsgId=null;
  toast('Message deleted.');
}

function fmtText(text,isMine){
  return esc(text).replace(/@(\w+)/g,(_,n)=>`<span class="mention${isMine?' me-m':''}">@${n}</span>`);
}

// ‚îÄ‚îÄ SEND (ImgBB for images, 0x0.st for videos) ‚îÄ‚îÄ
async function sendMsg(){
  const inp=g('ibox'); if(!inp||uploading)return;
  const text=inp.value.trim();
  if(!text&&!pendImgs.length)return;
  inp.value=''; inp.style.height='auto'; inp.focus();
  const base={uid:CU.uid,alias:CP.alias,color:CP.color,photoURL:CP.photoURL||'',ts:fb.serverTimestamp()};
  if(replyTo) base.replyTo=replyTo;
  clearReply();
  const toSend=[...pendImgs]; pendImgs=[];
  const strip=g('img-strip'); if(strip)strip.innerHTML='';

  if(toSend.length){
    setUploading(true);
    for(const item of toSend){
      try{
        let url, isVideo=item.isVideo;
        if(isVideo){
          url=await videoUpload(item.file);
          await fb.addDoc(fb.collection(fb.db,'rooms',CR,'messages'),{...base,videoUrl:url,text:''});
        } else {
          url=await imgbbUpload(item.file);
          await fb.addDoc(fb.collection(fb.db,'rooms',CR,'messages'),{...base,imageUrl:url,text:''});
        }
      }catch(e){
        console.error(e);
        toast(e.message||'Upload failed.');
      }
    }
    setUploading(false);
    inp.focus();
  }
  if(text) await fb.addDoc(fb.collection(fb.db,'rooms',CR,'messages'),{...base,text});
}

function setUploading(val){
  uploading=val;
  const ind=g('upload-indicator'), btn=g('send-btn');
  if(ind) ind.style.display=val?'flex':'none';
  if(btn) btn.disabled=val;
  g('ibox')?.focus();
}

// ‚îÄ‚îÄ KEY/INPUT ‚îÄ‚îÄ
function hKey(e){
  if(mentionActive){
    if(e.key==='ArrowDown'){mentionIdx++;renderMDD();e.preventDefault();return}
    if(e.key==='ArrowUp'){mentionIdx=Math.max(0,mentionIdx-1);renderMDD();e.preventDefault();return}
    if(e.key==='Enter'||e.key==='Tab'){selMention();e.preventDefault();return}
    if(e.key==='Escape'){closeMDD();return}
  }
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();return}
  autoH(e.target);
}
function hInput(inp){
  autoH(inp);
  const before=inp.value.slice(0,inp.selectionStart);
  const m=before.match(/@(\w*)$/);
  if(m){mentionQuery=m[1].toLowerCase();mentionActive=true;mentionIdx=0;renderMDD();}
  else closeMDD();
}
function autoH(inp){inp.style.height='auto';inp.style.height=Math.min(inp.scrollHeight,110)+'px';}
function getMCands(){return Object.values(allUsers).filter(u=>u.uid!==CU.uid&&(!mentionQuery||u.alias.toLowerCase().includes(mentionQuery))).slice(0,6);}
function renderMDD(){
  const box=g('mdd'); if(!box)return;
  const cands=getMCands();
  if(!cands.length){closeMDD();return}
  box.style.display='block'; box.innerHTML='';
  cands.forEach((u,i)=>{
    const it=document.createElement('div');it.className='mdd-item'+(i===mentionIdx%cands.length?' sel':'');
    const av=document.createElement('div');av.className='av';av.style.cssText='width:22px;height:22px;font-size:9px;flex-shrink:0';
    if(u.photoURL)av.innerHTML=`<img src="${u.photoURL}" alt="">`;
    else{av.style.background=u.color;av.textContent=u.alias[0].toUpperCase();}
    it.appendChild(av);
    const nm=document.createElement('span');nm.textContent=u.alias;it.appendChild(nm);
    it.onmousedown=e=>{e.preventDefault();mentionIdx=i;selMention();};
    box.appendChild(it);
  });
}
function selMention(){
  const cands=getMCands(); if(!cands.length)return;
  const chosen=cands[mentionIdx%cands.length];
  const inp=g('ibox');
  const before=inp.value.slice(0,inp.selectionStart).replace(/@\w*$/,'');
  inp.value=before+'@'+chosen.alias+' '+inp.value.slice(inp.selectionStart);
  inp.focus(); closeMDD();
}
function closeMDD(){mentionActive=false;const b=g('mdd');if(b)b.style.display='none';}

// ‚îÄ‚îÄ MEDIA PREVIEW ‚îÄ‚îÄ
function handleImgs(files){
  Array.from(files).forEach(file=>{
    const isVideo=file.type.startsWith('video/');
    const isImage=file.type.startsWith('image/');
    if(!isVideo&&!isImage)return;
    if(isImage&&file.size>20*1024*1024){toast('Image too large. Max 20MB.');return;}
    if(isVideo&&file.size>200*1024*1024){toast('Video too large. Max 200MB.');return;}
    const idx=pendImgs.length;
    pendImgs.push({file,isVideo,dataURL:null});
    const fr=new FileReader();
    fr.onload=e=>{
      pendImgs[idx].dataURL=e.target.result;
      const strip=g('img-strip'); if(!strip)return;
      const th=document.createElement('div');th.className='ithumb';
      if(isVideo){
        th.innerHTML=`<video src="${e.target.result}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid var(--bd2)"></video>
          <div style="position:absolute;bottom:2px;left:2px;background:rgba(0,0,0,.6);border-radius:3px;padding:1px 4px;font-size:9px;color:#fff">‚ñ∂</div>
          <button onclick="rmImg(this,${idx})">‚úï</button>`;
      } else {
        th.innerHTML=`<img src="${e.target.result}" alt=""><button onclick="rmImg(this,${idx})">‚úï</button>`;
      }
      strip.appendChild(th);
    };
    fr.readAsDataURL(file);
  });
  const fi=g('file-in'); if(fi)fi.value='';
}
function rmImg(btn,i){if(i>=0&&i<pendImgs.length)pendImgs.splice(i,1);btn.parentElement.remove();}

// ‚îÄ‚îÄ CREATE ROOM ‚îÄ‚îÄ
function openCreate(){openM('m-create');}
function togglePw(){
  const t=g('cr-t').value;
  g('cr-pw-f').classList.toggle('gone',t!=='private');
}
async function createRoom(){
  const name=v('cr-n'); if(name.length<2)return showErr('cr-err','Name must be 2+ characters.');
  const type=g('cr-t').value, pw=v('cr-pw');
  if(type==='private'&&!pw)return showErr('cr-err','Set a password for private rooms.');
  // Generate invite code for all rooms
  const inviteCode=genCode();
  const data={name,icon:v('cr-i')||'üí¨',desc:v('cr-d'),type,adminUid:CU.uid,adminAlias:CP.alias,
    createdAt:fb.serverTimestamp(),inviteCode};
  if(type==='private')data.password=pw;
  const ref=await fb.addDoc(fb.collection(fb.db,'rooms'),data);
  await fb.setDoc(fb.doc(fb.db,'rooms',ref.id,'members',CU.uid),{joinedAt:fb.serverTimestamp()});
  await fb.addDoc(fb.collection(fb.db,'rooms',ref.id,'messages'),{type:'system',text:`Room created by ${CP.alias}`,ts:fb.serverTimestamp()});
  closeM('m-create');toast(`Room "${name}" created! üéâ`);
  ['cr-n','cr-i','cr-d'].forEach(id=>{const el=g(id);if(el)el.value='';});
}
function genCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:6},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

// ‚îÄ‚îÄ ROOM SETTINGS with tabs ‚îÄ‚îÄ
let curRsTab='general';
function rsTab(name,btn){
  curRsTab=name;
  ['general','members','invite','requests'].forEach(t=>{
    g(`rs-tab-${t}`)?.classList.toggle('gone',t!==name);
  });
  document.querySelectorAll('.itab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(name==='members') loadSettingsMembers();
  if(name==='invite') loadInviteTab();
  if(name==='requests') loadJoinRequests();
}

function openSettings(){
  g('rs-rname').textContent=`#${CRD.name}`;
  g('rs-n').value=CRD.name;
  g('rs-d').value=CRD.desc||'';
  g('rs-pw').value='';
  // Reset to general tab
  rsTab('general',document.querySelector('.itab'));
  openM('m-settings');
}

async function loadSettingsMembers(){
  const list=g('rs-members-list'); if(!list)return;
  list.innerHTML='<div style="color:var(--mu);font-size:13px;padding:10px">Loading‚Ä¶</div>';
  const snap=await fb.getDocs(fb.collection(fb.db,'rooms',CR,'members'));
  const memberIds=snap.docs.map(d=>d.id);
  if(CRD.adminUid&&!memberIds.includes(CRD.adminUid)) memberIds.unshift(CRD.adminUid);
  list.innerHTML='';
  for(const uid of memberIds){
    if(!allUsers[uid]){
      const u=await fb.getDoc(fb.doc(fb.db,'users',uid));
      if(u.exists()) allUsers[uid]=u.data();
    }
    const u=allUsers[uid]; if(!u)continue;
    const isAdmin=u.uid===CRD.adminUid;
    const row=document.createElement('div');row.className='member-row';
    const av=document.createElement('div');av.className='av';av.style.cssText='width:30px;height:30px;font-size:11px;flex-shrink:0';
    if(u.photoURL)av.innerHTML=`<img src="${u.photoURL}" alt="">`;
    else{av.style.background=u.color||'var(--acc)';av.textContent=(u.alias||'?')[0].toUpperCase();}
    const info=document.createElement('div');info.className='member-info';
    info.innerHTML=`<div class="member-name" style="color:${u.color||'var(--tx)'}">${esc(u.alias)}</div>
      <div class="member-role">${isAdmin?'üëë Admin':''}</div>`;
    row.appendChild(av); row.appendChild(info);
    if(!isAdmin){
      const kick=document.createElement('button');kick.className='mem-btn kick';kick.textContent='Kick';
      kick.onclick=async()=>{
        if(!confirm(`Remove ${u.alias} from this room?`)) return;
        await fb.deleteDoc(fb.doc(fb.db,'rooms',CR,'members',u.uid));
        row.remove(); toast(`${u.alias} removed.`);
      };
      row.appendChild(kick);
    }
    list.appendChild(row);
  }
}

async function loadInviteTab(){
  // Ensure room has an invite code
  let code=CRD.inviteCode;
  if(!code){code=genCode();await fb.updateDoc(fb.doc(fb.db,'rooms',CR),{inviteCode:code});CRD.inviteCode=code;}
  g('rs-invite-code').textContent=code;
  g('rs-invite-link').textContent=`${location.origin}${location.pathname}?invite=${code}`;
}
async function genNewCode(){
  const code=genCode();
  await fb.updateDoc(fb.doc(fb.db,'rooms',CR),{inviteCode:code});
  CRD.inviteCode=code;
  g('rs-invite-code').textContent=code;
  g('rs-invite-link').textContent=`${location.origin}${location.pathname}?invite=${code}`;
  toast('New invite code generated!');
}
function copyInviteCode(){
  navigator.clipboard.writeText(CRD.inviteCode||'').then(()=>toast('Invite code copied! üìã'));
}
function copyInviteLink(){
  const link=`${location.origin}${location.pathname}?invite=${CRD.inviteCode||''}`;
  navigator.clipboard.writeText(link).then(()=>toast('Invite link copied! üìã'));
}

async function loadJoinRequests(){
  const box=g('rs-reqs2'); if(!box||!CR)return;
  box.innerHTML='<div style="color:var(--mu);font-size:13px;padding:10px">Loading‚Ä¶</div>';
  const snap=await fb.getDocs(fb.query(fb.collection(fb.db,'rooms',CR,'requests'),fb.where('status','==','pending')));
  if(snap.empty){box.innerHTML='<div class="req-empty">No pending requests.</div>';return;}
  box.innerHTML='';
  snap.forEach(d=>{
    const req=d.data();
    const div=document.createElement('div');div.className='req-item';
    const av=document.createElement('div');av.className='av';av.style.cssText='width:30px;height:30px;font-size:12px;flex-shrink:0';
    if(req.photoURL)av.innerHTML=`<img src="${req.photoURL}" alt="">`;
    else{av.style.background=req.color||'var(--acc)';av.textContent=(req.alias||'?')[0].toUpperCase();}
    const info=document.createElement('div');info.className='req-info';
    info.innerHTML=`<div class="req-name" style="color:${req.color||'var(--acc)'}">${esc(req.alias)}</div>${req.message?`<div class="req-msg">"${esc(req.message)}"</div>`:''}`;
    const btns=document.createElement('div');btns.className='req-btns';
    const yes=document.createElement('button');yes.className='req-yes';yes.textContent='‚úì';
    yes.onclick=async()=>{
      await fb.setDoc(fb.doc(fb.db,'rooms',CR,'members',d.id),{joinedAt:fb.serverTimestamp()});
      await fb.updateDoc(fb.doc(fb.db,'rooms',CR,'requests',d.id),{status:'accepted'});
      div.remove(); toast(`${req.alias} added!`);
    };
    const no=document.createElement('button');no.className='req-no';no.textContent='‚úï';
    no.onclick=async()=>{
      await fb.updateDoc(fb.doc(fb.db,'rooms',CR,'requests',d.id),{status:'rejected'});
      div.remove(); toast('Request rejected.');
    };
    btns.appendChild(yes); btns.appendChild(no);
    div.appendChild(av); div.appendChild(info); div.appendChild(btns);
    box.appendChild(div);
  });
}

async function saveRoomSettings(){
  const name=v('rs-n'); if(!name)return showErr('rs-err','Name cannot be empty.');
  const upd={name,desc:v('rs-d')};
  const pw=v('rs-pw');
  if(pw){upd.password=pw;upd.type='private';}
  else if(CRD.type==='private'){upd.type='public';}
  await fb.updateDoc(fb.doc(fb.db,'rooms',CR),upd);
  closeM('m-settings'); toast('Settings saved!');
}
function confirmDeleteRoom(){closeM('m-settings');g('del-room-title').textContent=`Delete "${CRD?.name}"?`;openM('m-del-room');}
async function executeDeleteRoom(){
  const roomId=CR;
  if(unsubM){unsubM();unsubM=null;}
  CR=null; CRD=null;
  closeM('m-del-room');
  g('chat').innerHTML=`
    <div style="display:flex;flex-direction:column;height:100dvh;background:var(--bg)">
      <div class="ch-head"><button class="ham" onclick="openSb()">‚ò∞</button>
        <div style="color:var(--mu2);font-size:14px;padding-left:4px">Room deleted</div>
      </div>
      <div class="empty"><div class="em">üí¨</div><p>Room deleted.<br>Select another channel.</p></div>
    </div>`;
  document.querySelectorAll('.ri').forEach(x=>x.classList.remove('active'));
  await fb.deleteDoc(fb.doc(fb.db,'rooms',roomId));
  toast('Room deleted.');
  openSb();
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
function openProfile(){
  const av=g('pav');
  if(CP.photoURL){av.innerHTML=`<img src="${CP.photoURL}" alt="">`;av.style.background='';}
  else{av.innerHTML='';av.textContent=CP.alias[0].toUpperCase();av.style.background=CP.color;}
  g('pname').textContent=CP.alias;
  g('p-uname-badge').textContent='@'+CP.alias;
  g('pemail').textContent=CP.caption?`"${CP.caption}"`:CP.email||'';
  g('p-alias').value=CP.alias;
  g('p-alias-err').style.display='none';
  if(g('p-caption')) g('p-caption').value=CP.caption||'';
  profColor=CP.color;
  buildColPicker('p-colors',c=>profColor=c,CP.color);
  openM('m-profile');
}

function uploadAvatar(file){if(!file)return;openCropModal(file);}

// ‚îÄ‚îÄ CROP ‚îÄ‚îÄ
let cropImg=null,cropX=0,cropY=0,cropScale=1,cropDragging=false,cropLX=0,cropLY=0,cropPinchDist=0;
function openCropModal(file){
  const reader=new FileReader();
  reader.onload=e=>{
    cropImg=new Image();
    cropImg.onload=()=>{
      cropX=0;cropY=0;cropScale=1;
      initCropCanvas();
      closeM('m-profile');
      openM('m-crop');
    };
    cropImg.src=e.target.result;
  };
  reader.readAsDataURL(file);
}
function initCropCanvas(){
  const wrap=g('crop-wrap'),canvas=g('crop-canvas');
  if(!wrap||!canvas||!cropImg)return;
  canvas.width=wrap.offsetWidth||320; canvas.height=260;
  const sx=canvas.width/cropImg.width,sy=canvas.height/cropImg.height;
  cropScale=Math.max(sx,sy);
  cropX=(canvas.width-cropImg.width*cropScale)/2;
  cropY=(canvas.height-cropImg.height*cropScale)/2;
  drawCrop();
  wrap.onmousedown=e=>{cropDragging=true;cropLX=e.clientX;cropLY=e.clientY;wrap.classList.add('dragging');};
  window.onmousemove=e=>{if(!cropDragging)return;cropX+=e.clientX-cropLX;cropY+=e.clientY-cropLY;cropLX=e.clientX;cropLY=e.clientY;clampCrop();drawCrop();};
  window.onmouseup=()=>{cropDragging=false;wrap.classList.remove('dragging');};
  wrap.onwheel=e=>{e.preventDefault();zoomCrop(e.deltaY<0?1.1:.91,canvas.width/2,canvas.height/2);};
  wrap.ontouchstart=e=>{
    if(e.touches.length===1){cropDragging=true;cropLX=e.touches[0].clientX;cropLY=e.touches[0].clientY;}
    if(e.touches.length===2)cropPinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    e.preventDefault();
  };
  wrap.ontouchmove=e=>{
    if(e.touches.length===1&&cropDragging){
      cropX+=e.touches[0].clientX-cropLX;cropY+=e.touches[0].clientY-cropLY;
      cropLX=e.touches[0].clientX;cropLY=e.touches[0].clientY;
      clampCrop();drawCrop();
    }
    if(e.touches.length===2){
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      const cx=(e.touches[0].clientX+e.touches[1].clientX)/2;
      const cy=(e.touches[0].clientY+e.touches[1].clientY)/2;
      const rect=wrap.getBoundingClientRect();
      zoomCrop(d/cropPinchDist,cx-rect.left,cy-rect.top);
      cropPinchDist=d;
    }
    e.preventDefault();
  },{passive:false};
  wrap.ontouchend=()=>{cropDragging=false;};
}
function zoomCrop(f,cx,cy){
  const ns=Math.min(Math.max(cropScale*f,.5),8);
  const r=ns/cropScale;
  cropX=cx-(cx-cropX)*r;cropY=cy-(cy-cropY)*r;
  cropScale=ns;clampCrop();drawCrop();
}
function clampCrop(){
  const canvas=g('crop-canvas');if(!canvas||!cropImg)return;
  const w=cropImg.width*cropScale,h=cropImg.height*cropScale;
  const cx=canvas.width/2,cy=canvas.height/2,r=100;
  if(cropX>cx-r)cropX=cx-r;
  if(cropX+w<cx+r)cropX=cx+r-w;
  if(cropY>cy-r)cropY=cy-r;
  if(cropY+h<cy+r)cropY=cy+r-h;
}
function drawCrop(){
  const canvas=g('crop-canvas');if(!canvas||!cropImg)return;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(cropImg,cropX,cropY,cropImg.width*cropScale,cropImg.height*cropScale);
}
async function cropAndUpload(){
  const canvas=g('crop-canvas');if(!canvas||!cropImg)return;
  const out=document.createElement('canvas');out.width=300;out.height=300;
  const ctx=out.getContext('2d');
  ctx.beginPath();ctx.arc(150,150,150,0,Math.PI*2);ctx.clip();
  const cw=canvas.width,ch=canvas.height,r=100,cx=cw/2,cy=ch/2;
  const srcX=(cx-r-cropX)/cropScale,srcY=(cy-r-cropY)/cropScale;
  const srcW=200/cropScale,srcH=200/cropScale;
  ctx.drawImage(cropImg,srcX,srcY,srcW,srcH,0,0,300,300);
  out.toBlob(async blob=>{
    closeM('m-crop');openM('m-profile');toast('Uploading photo‚Ä¶');
    try{
      const file=new File([blob],'avatar.jpg',{type:'image/jpeg'});
      const url=await imgbbUpload(file);
      CP.photoURL=url;
      await fb.setDoc(fb.doc(fb.db,'users',CU.uid),CP);
      const av=g('pav');av.innerHTML=`<img src="${url}" alt="">`;av.style.background='';
      updatePill();toast('Photo updated! ‚úì');
    }catch(e){console.error(e);toast('Upload failed.');}
  },'image/jpeg',.92);
}

async function saveProfile(){
  const alias=v('p-alias');
  if(!/^[\w]{3,20}$/.test(alias)) return showErr('p-alias-err','3‚Äì20 chars, letters/numbers/_ only.');
  if(alias!==CP.alias){
    const q=fb.query(fb.collection(fb.db,'users'),fb.where('alias','==',alias));
    const snap=await fb.getDocs(q);
    if(!snap.empty&&snap.docs[0].id!==CU.uid) return showErr('p-alias-err','Username already taken.');
  }
  CP.alias=alias; CP.color=profColor;
  CP.caption=(g('p-caption')?.value||'').trim().slice(0,60);
  await fb.setDoc(fb.doc(fb.db,'users',CU.uid),CP);
  allUsers[CU.uid]=CP; updatePill(); closeM('m-profile'); toast('Profile updated! ‚úì');
}

function buildColPicker(containerId,onChange,active){
  const c=g(containerId);if(!c)return;c.innerHTML='';
  COLORS.forEach(col=>{
    const d=document.createElement('div');d.className='cdot'+(col===(active||selColor)?' on':'');
    d.style.background=col;
    d.onclick=()=>{c.querySelectorAll('.cdot').forEach(x=>x.classList.remove('on'));d.classList.add('on');onChange(col);};
    c.appendChild(d);
  });
}

// ‚îÄ‚îÄ JOIN REQUEST ‚îÄ‚îÄ
function openJoinReq(){
  closeM('m-join');
  if(!joinTarget)return;
  g('jr-room-name').textContent=`Requesting to join: ${joinTarget.name}`;
  g('req-msg').value=''; g('req-err').style.display='none';
  openM('m-join-req');
}
async function sendJoinRequest(){
  if(!joinTarget)return;
  const msg=v('req-msg');
  const existing=await fb.getDoc(fb.doc(fb.db,'rooms',joinTarget.id,'requests',CU.uid));
  if(existing.exists()&&existing.data().status==='pending'){
    g('req-err').textContent='You already have a pending request.';
    g('req-err').style.display='block';return;
  }
  await fb.setDoc(fb.doc(fb.db,'rooms',joinTarget.id,'requests',CU.uid),{
    uid:CU.uid,alias:CP.alias,color:CP.color,photoURL:CP.photoURL||'',
    message:msg,status:'pending',ts:fb.serverTimestamp()
  });
  closeM('m-join-req'); joinTarget=null;
  toast('Request sent! Wait for admin approval.');
}

// ‚îÄ‚îÄ VIEW USER PROFILE ‚îÄ‚îÄ
let vpTarget=null;
function viewUserProfile(uid,alias,color,photoURL){
  vpTarget={uid,alias,color,photoURL};
  const av=g('vp-av');
  if(photoURL){av.innerHTML=`<img src="${photoURL}" alt="">`;av.style.background='';}
  else{av.innerHTML='';av.textContent=alias[0].toUpperCase();av.style.background=color;}
  g('vp-name').textContent=alias;
  g('vp-badge').textContent='@'+alias;
  g('vp-badge').style.color=color;
  // Load caption from allUsers
  const udata=allUsers[uid]||{};
  const capEl=g('vp-caption');
  if(capEl) capEl.textContent=udata.caption||'';
  openM('m-view-prof');
}
function vpZoom(){if(vpTarget?.photoURL){openLightbox(vpTarget.photoURL,false);}}
function startDMFromProfile(){if(!vpTarget)return;closeM('m-view-prof');openDM(vpTarget);}

// ‚îÄ‚îÄ DIRECT MESSAGES (private to the two users) ‚îÄ‚îÄ
// DMs are stored in rooms with type='dm' and a members array
// Messages are in the room's messages subcollection - only the two members see the room in their sidebar
async function openDM(user){
  const dmId='dm_'+[CU.uid,user.uid].sort().join('_');
  const ref=fb.doc(fb.db,'rooms',dmId);
  const snap=await fb.getDoc(ref);
  if(!snap.exists()){
    await fb.setDoc(ref,{
      name:user.alias,           // store other person's alias as the room name
      nameFor:{[CU.uid]:user.alias,[user.uid]:CP.alias}, // each sees the other's name
      icon:'üí¨',desc:'Direct message',
      type:'dm',adminUid:null,
      members:[CU.uid,user.uid],
      createdAt:fb.serverTimestamp()
    });
  }
  const data=snap.exists()?{id:dmId,...snap.data()}:{id:dmId,name:user.alias,nameFor:{[CU.uid]:user.alias,[user.uid]:CP.alias},icon:'üí¨',desc:'Direct message',type:'dm',adminUid:null,members:[CU.uid,user.uid]};
  // Show the other person's name for current user
  const displayName=data.nameFor?.[CU.uid]||user.alias;
  openRoom({...data,name:displayName});
  closeSb();
}

// ‚îÄ‚îÄ PEOPLE SEARCH ‚îÄ‚îÄ
function filterPeople(q){
  const list=g('people-list');if(!list)return;
  const users=Object.values(allUsers).filter(u=>u.uid!==CU.uid&&(!q||u.alias.toLowerCase().includes(q.toLowerCase())));
  list.innerHTML='';
  if(!users.length){list.innerHTML='<div class="req-empty">No users found.</div>';return;}
  users.forEach(u=>{
    const card=document.createElement('div');card.className='user-card';
    const av=document.createElement('div');av.className='av';av.style.cssText='width:36px;height:36px;font-size:14px;flex-shrink:0';
    if(u.photoURL)av.innerHTML=`<img src="${u.photoURL}" alt="">`;
    else{av.style.background=u.color;av.textContent=u.alias[0].toUpperCase();}
    const info=document.createElement('div');info.className='user-card-info';
    info.innerHTML=`<div class="user-card-name" style="color:${u.color}">${esc(u.alias)}</div><div class="user-card-sub">@${esc(u.alias)}</div>`;
    const btn=document.createElement('button');btn.className='dm-btn';btn.textContent='Message';
    btn.onclick=e=>{e.stopPropagation();closeM('m-people');openDM(u);};
    card.appendChild(av);card.appendChild(info);card.appendChild(btn);
    card.onclick=()=>{closeM('m-people');viewUserProfile(u.uid,u.alias,u.color,u.photoURL||'');};
    list.appendChild(card);
  });
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ
function openM(id){
  g(id)?.classList.remove('gone');
  if(id==='m-people'){g('people-q').value='';filterPeople('');}
}
function closeM(id){g(id)?.classList.add('gone');}
document.querySelectorAll('.ov').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.add('gone');}));

// override ibtn in chat head for members
document.addEventListener('click',e=>{
  if(e.target.closest('.ibtn[onclick="openM(\'m-room-members\')"]')||
     (e.target.closest('.ibtn')&&e.target.closest('.ibtn').getAttribute('onclick')==="openM('m-room-members')")){
    window._openRoomMembers();
  }
});

// Check URL for invite code on load
window.addEventListener('load',()=>{
  const params=new URLSearchParams(location.search);
  const inv=params.get('invite');
  if(inv){
    // Store it and apply after login
    sessionStorage.setItem('pendingInvite',inv.toUpperCase());
  }
});

// ‚îÄ‚îÄ LEAVE GROUP ‚îÄ‚îÄ
async function leaveRoom(){
  if(!CR||!CRD) return;
  if(!confirm(`Leave "${CRD.name}"? You'll need a new invite to rejoin.`)) return;
  closeM('m-room-members');
  await fb.deleteDoc(fb.doc(fb.db,'rooms',CR,'members',CU.uid));
  if(unsubM){unsubM();unsubM=null;}
  CR=null; CRD=null;
  document.querySelectorAll('.ri').forEach(x=>x.classList.remove('active'));
  g('chat').innerHTML=`<div style="display:flex;flex-direction:column;height:100dvh;background:var(--bg)">
    <div class="ch-head"><button class="ham" onclick="openSb()">‚ò∞</button></div>
    <div class="empty"><div class="em">üëã</div><p>You left the room.<br>Select another channel.</p></div>
  </div>`;
  toast('You left the room.');
  openSb();
}

// ‚îÄ‚îÄ SEND GROUP INVITE TO PERSON ‚îÄ‚îÄ
function openSendInvite(){
  if(!CR||!CRD){toast('Open a room first.');return;}
  g('send-inv-roomname').textContent=`Invite someone to join: ${CRD.name}`;
  g('send-inv-q').value='';
  g('send-inv-err').style.display='none';
  filterInvitePeople('');
  openM('m-send-invite');
}
function filterInvitePeople(q){
  const list=g('send-inv-list');if(!list)return;
  const users=Object.values(allUsers).filter(u=>u.uid!==CU.uid&&(!q||u.alias.toLowerCase().includes(q.toLowerCase())));
  list.innerHTML='';
  if(!users.length){list.innerHTML='<div class="req-empty">No users found.</div>';return;}
  users.forEach(u=>{
    const card=document.createElement('div');card.className='user-card';
    const av=document.createElement('div');av.className='av';av.style.cssText='width:32px;height:32px;font-size:12px;flex-shrink:0';
    if(u.photoURL)av.innerHTML=`<img src="${u.photoURL}" alt="">`;
    else{av.style.background=u.color;av.textContent=u.alias[0].toUpperCase();}
    const info=document.createElement('div');info.className='user-card-info';
    info.innerHTML=`<div class="user-card-name" style="color:${u.color}">${esc(u.alias)}</div><div class="user-card-sub">@${esc(u.alias)}</div>`;
    const btn=document.createElement('button');btn.className='dm-btn';btn.textContent='Invite üì®';
    btn.onclick=async e=>{
      e.stopPropagation();
      btn.textContent='Sending‚Ä¶';btn.disabled=true;
      await sendGroupInvite(u);
      btn.textContent='Sent ‚úì';
    };
    card.appendChild(av);card.appendChild(info);card.appendChild(btn);
    list.appendChild(card);
  });
}
async function sendGroupInvite(toUser){
  // Store invite in Firestore under the target user's invites subcollection
  await fb.setDoc(fb.doc(fb.db,'users',toUser.uid,'invites',CR+'_'+CU.uid),{
    roomId:CR,
    roomName:CRD.name,
    roomIcon:CRD.icon||'üí¨',
    fromUid:CU.uid,
    fromAlias:CP.alias,
    fromColor:CP.color,
    status:'pending',
    ts:fb.serverTimestamp()
  });
  toast(`Invite sent to ${toUser.alias}! üì®`);
}

// ‚îÄ‚îÄ RECEIVE INVITES (bell) ‚îÄ‚îÄ
let unsubInvites=null;
function subscribeInvites(){
  if(!CU) return;
  unsubInvites=fb.onSnapshot(
    fb.query(fb.collection(fb.db,'users',CU.uid,'invites'),fb.where('status','==','pending')),
    snap=>{
      const dot=g('inv-dot');
      if(dot) dot.classList.toggle('visible',!snap.empty);
    }
  );
}
async function openMyInvites(){
  const list=g('my-invites-list');
  list.innerHTML='<div style="color:var(--mu);text-align:center;padding:16px">Loading‚Ä¶</div>';
  openM('m-my-invites');
  const snap=await fb.getDocs(fb.query(fb.collection(fb.db,'users',CU.uid,'invites'),fb.where('status','==','pending')));
  list.innerHTML='';
  if(snap.empty){list.innerHTML='<div class="req-empty">No pending invitations.</div>';return;}
  snap.forEach(d=>{
    const inv=d.data();
    const item=document.createElement('div');item.className='inv-notif-item';
    item.innerHTML=`
      <div class="inv-notif-head">
        <span style="font-size:18px">${esc(inv.roomIcon)}</span>
        <span><b style="color:${esc(inv.fromColor)}">${esc(inv.fromAlias)}</b> invited you to join</span>
        <span class="inv-notif-room">#${esc(inv.roomName)}</span>
      </div>
      <div class="inv-notif-btns">
        <button class="req-yes" style="flex:1" data-id="${d.id}" data-room="${inv.roomId}">‚úì Accept</button>
        <button class="req-no" data-id="${d.id}">‚úï Decline</button>
      </div>`;
    item.querySelector('.req-yes').onclick=async e=>{
      const invId=e.target.dataset.id, roomId=e.target.dataset.room;
      await fb.setDoc(fb.doc(fb.db,'rooms',roomId,'members',CU.uid),{joinedAt:fb.serverTimestamp()});
      await fb.updateDoc(fb.doc(fb.db,'users',CU.uid,'invites',invId),{status:'accepted'});
      item.remove();
      toast('You joined the room! üéâ');
      // Open the room
      const rs=await fb.getDoc(fb.doc(fb.db,'rooms',roomId));
      if(rs.exists()){closeM('m-my-invites');openRoom({id:roomId,...rs.data()});}
    };
    item.querySelector('.req-no').onclick=async e=>{
      await fb.updateDoc(fb.doc(fb.db,'users',CU.uid,'invites',e.target.dataset.id),{status:'declined'});
      item.remove();
      if(!list.children.length)list.innerHTML='<div class="req-empty">No pending invitations.</div>';
    };
    list.appendChild(item);
  });
}

// ‚îÄ‚îÄ utils ‚îÄ‚îÄ
function g(id){return document.getElementById(id);}
function v(id){return(g(id)?.value||'').trim();}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function showErr(id,msg){const e=g(id);if(e){e.textContent=msg;e.style.display='block';e.style.color='var(--acc2)';}}
function toast(msg,ms=2800){const t=g('toast');t.textContent=msg;t.classList.add('on');setTimeout(()=>t.classList.remove('on'),ms);}
function rbg(id){const h=[...(id||'x')].reduce((a,c)=>a+c.charCodeAt(0),0);return COLORS[h%COLORS.length]+'22';}
function fe(code){return({'auth/user-not-found':'No account found.','auth/wrong-password':'Wrong password.','auth/invalid-email':'Invalid email.','auth/email-already-in-use':'Email already registered.','auth/too-many-requests':'Too many attempts. Try later.','auth/invalid-credential':'Invalid email or password.','auth/popup-closed-by-user':'Sign-in cancelled.','auth/popup-blocked':'Allow popups for this site.','auth/account-exists-with-different-credential':'Account exists with different sign-in method.'}[code]||'Something went wrong.');}
</script>
</body>
</html>
