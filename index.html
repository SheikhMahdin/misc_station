<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MISC Station</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
  onAuthStateChanged, GoogleAuthProvider, signInWithPopup }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy,
  doc, setDoc, getDoc, getDocs, updateDoc, serverTimestamp, deleteDoc, where }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA9bRUWizN9nzYoxiLRw9LoVp8kSfOgqdI",
  authDomain: "misc-station.firebaseapp.com",
  projectId: "misc-station",
  storageBucket: "misc-station.firebasestorage.app",
  messagingSenderId: "362458705836",
  appId: "1:362458705836:web:3672a003d49df576cdd409",
  measurementId: "G-GG5QQH705Z"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const storage = getStorage(app);

window._fb = { auth, db, storage,
  createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
  onAuthStateChanged, GoogleAuthProvider, signInWithPopup,
  collection, addDoc, onSnapshot, query, orderBy,
  doc, setDoc, getDoc, getDocs, updateDoc, serverTimestamp, deleteDoc, where,
  ref, uploadBytes, getDownloadURL };
window.dispatchEvent(new Event('firebase-ready'));
</script>

<style>
:root {
  --bg:#07090f;--s1:#0c0f1a;--s2:#111525;--s3:#171d30;
  --bd:#1c2238;--bd2:#222a42;
  --acc:#5b8fff;--acc2:#ff5b8f;--acc3:#5bffc0;--warn:#ffc85b;
  --tx:#dde4f5;--mu:#546080;--mu2:#8a9bb8;--r:12px;
  --sb-w:280px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%;-webkit-text-size-adjust:100%}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);font-size:15px;height:100%;overflow:hidden;-webkit-tap-highlight-color:transparent}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:4px}

.bg-noise{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.03;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
.glow{position:fixed;border-radius:50%;filter:blur(90px);pointer-events:none;z-index:0}
.g1{width:500px;height:500px;background:rgba(91,143,255,.07);top:-150px;left:-100px}
.g2{width:400px;height:400px;background:rgba(255,91,143,.05);bottom:-80px;right:-80px}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{position:fixed;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;padding:16px}
.gone{display:none!important}

.card{
  background:rgba(12,15,26,.97);border:1px solid var(--bd2);border-radius:20px;
  padding:36px 32px;width:100%;max-width:420px;position:relative;z-index:1;
  backdrop-filter:blur(20px);
  box-shadow:0 32px 80px rgba(0,0,0,.55),inset 0 1px 0 rgba(255,255,255,.04);
  animation:rise .4s cubic-bezier(.16,1,.3,1) both;
  max-height:95vh;overflow-y:auto}
@keyframes rise{from{opacity:0;transform:translateY(26px) scale(.98)}to{opacity:1;transform:none}}

.brand{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.brand-dot{width:8px;height:8px;border-radius:50%;background:var(--acc);box-shadow:0 0 10px var(--acc);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
.brand-tag{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--acc);text-transform:uppercase}
.card h1{font-size:24px;font-weight:800;line-height:1.2;margin-bottom:5px}
.card .sub{color:var(--mu2);font-size:13px;margin-bottom:22px;font-weight:300;line-height:1.5}

.field{margin-bottom:13px}
.field label{display:block;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--mu);margin-bottom:6px;font-family:'JetBrains Mono',monospace}
.field input,.field select,.field textarea{
  width:100%;padding:12px 14px;background:var(--s2);border:1px solid var(--bd2);
  border-radius:10px;color:var(--tx);font-family:'Outfit',sans-serif;font-size:15px;
  outline:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none;appearance:none}
.field input:focus,.field select:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(91,143,255,.11)}
.field select option{background:var(--s2)}

.btn{width:100%;padding:14px;border:none;border-radius:10px;cursor:pointer;
  font-family:'Outfit',sans-serif;font-size:15px;font-weight:700;
  background:linear-gradient(135deg,var(--acc),#2d66e0);color:#fff;
  transition:opacity .2s,transform .1s,box-shadow .2s;
  box-shadow:0 4px 18px rgba(91,143,255,.28);margin-top:4px;min-height:48px}
.btn:hover{opacity:.91}
.btn:active{transform:scale(.97)}
.btn.ghost{background:var(--s2);color:var(--tx);border:1px solid var(--bd2);box-shadow:none}
.btn.ghost:hover{background:var(--s3);opacity:1}
.btn.red{background:linear-gradient(135deg,#ff3a5c,#c00030);box-shadow:0 4px 18px rgba(255,58,92,.28)}
.btn.sm{width:auto;padding:10px 18px;font-size:13px;margin-top:0;min-height:40px}
.btn.google{background:#fff;color:#1a1a1a;display:flex;align-items:center;justify-content:center;gap:9px;font-size:14px;margin-top:0;box-shadow:0 2px 12px rgba(0,0,0,.3)}
.btn.google:hover{background:#f5f5f5;opacity:1}

.divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:var(--mu);font-size:12px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--bd2)}

.err{color:var(--acc2);font-size:12px;margin-top:5px;display:none;font-family:'JetBrains Mono',monospace}
.lnk{text-align:center;margin-top:16px;font-size:13px;color:var(--mu2)}
.lnk a{color:var(--acc);cursor:pointer;font-weight:600}
.lnk a:hover{text-decoration:underline}

.warn-em{font-size:38px;margin-bottom:10px}
.warn-box{background:rgba(255,200,91,.06);border:1px solid rgba(255,200,91,.2);border-radius:11px;padding:14px 16px;margin:14px 0}
.warn-box p{font-size:13px;line-height:1.7;color:var(--warn)}
.rules{list-style:none}
.rules li{display:flex;align-items:flex-start;gap:10px;font-size:13px;color:var(--mu2);padding:7px 0;border-bottom:1px solid var(--bd);line-height:1.5}
.rules li:last-child{border:none}
.rdot{width:6px;height:6px;border-radius:50%;background:var(--acc3);flex-shrink:0;margin-top:5px}
.agree-row{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--mu2);cursor:pointer;margin:16px 0 13px}
.agree-row input{accent-color:var(--acc);width:18px;height:18px;flex-shrink:0}

.alias-tip{background:rgba(91,255,192,.07);border:1px solid rgba(91,255,192,.15);border-radius:8px;padding:10px 14px;font-size:11.5px;color:var(--acc3);font-family:'JetBrains Mono',monospace;margin-bottom:15px}
.username-tip{background:rgba(91,143,255,.07);border:1px solid rgba(91,143,255,.15);border-radius:8px;padding:10px 14px;font-size:11.5px;color:var(--acc);font-family:'JetBrains Mono',monospace;margin-bottom:10px}
.col-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.cdot{width:30px;height:30px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color .15s,transform .15s}
.cdot.on,.cdot:hover{border-color:#fff;transform:scale(1.15)}

/* ‚ïê‚ïê APP ‚ïê‚ïê */
#app{position:fixed;inset:0;z-index:15;display:flex;overflow:hidden}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sb{
  width:var(--sb-w);flex-shrink:0;background:var(--s1);
  border-right:1px solid var(--bd);
  display:flex;flex-direction:column;height:100vh;
  position:relative;z-index:2;transition:transform .3s cubic-bezier(.16,1,.3,1)}
.sb-top{padding:13px 14px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;gap:8px}
.sb-logo{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--acc)}
.sb-logo small{display:block;color:var(--mu);font-size:9px;letter-spacing:1px;margin-top:1px}
.upill{display:flex;align-items:center;gap:7px;background:var(--s2);border:1px solid var(--bd2);border-radius:20px;padding:5px 10px 5px 5px;cursor:pointer;transition:background .15s;min-width:0;flex-shrink:0}
.upill:hover{background:var(--s3)}
.upill span{font-size:12px;font-weight:600;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;overflow:hidden}
.av img{width:100%;height:100%;object-fit:cover}
.av.lg{width:70px;height:70px;font-size:26px}

.sb-search{padding:9px 11px}
.sb-search input{width:100%;padding:9px 13px;background:var(--s2);border:1px solid var(--bd);border-radius:8px;color:var(--tx);font-size:14px;outline:none;font-family:'Outfit',sans-serif}
.sb-search input:focus{border-color:var(--acc)}

.sb-sec{padding:5px 12px 3px;font-size:10px;letter-spacing:2px;color:var(--mu);font-family:'JetBrains Mono',monospace;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between}
.sb-sec button{background:none;border:none;color:var(--mu);cursor:pointer;font-size:17px;line-height:1;padding:3px 5px;border-radius:4px}
.sb-sec button:hover{color:var(--acc);background:rgba(91,143,255,.1)}

.rlist{flex:1;overflow-y:auto;padding:4px 8px}
.ri{padding:10px;border-radius:9px;cursor:pointer;transition:background .12s;display:flex;align-items:center;gap:9px;margin-bottom:1px;position:relative}
.ri:hover{background:var(--s2)}
.ri.active{background:var(--s3);border:1px solid var(--bd2)}
.ri-ico{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.ri-info{flex:1;min-width:0}
.ri-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:5px}
.ri-prev{font-size:11px;color:var(--mu);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.lock{font-size:10px;color:var(--mu)}

.sb-foot{padding:9px;border-top:1px solid var(--bd)}
.sb-btn{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--mu2);transition:background .15s,color .15s;min-height:40px}
.sb-btn:hover{background:var(--s2);color:var(--acc2)}

/* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
.chat{flex:1;display:flex;flex-direction:column;height:100vh;background:var(--bg);position:relative;overflow:hidden;min-width:0}
.ch-head{padding:12px 16px;border-bottom:1px solid var(--bd);background:var(--s1);display:flex;align-items:center;gap:10px;flex-shrink:0;min-height:58px}
.ch-ico{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.ch-info h2{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ch-info p{font-size:11px;color:var(--mu);font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.online{display:inline-flex;align-items:center;gap:5px}
.online::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--acc3);animation:pulse 2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.ch-acts{margin-left:auto;display:flex;gap:6px;flex-shrink:0}
.ibtn{width:34px;height:34px;border-radius:8px;border:1px solid var(--bd2);background:var(--s2);color:var(--mu2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:background .15s,color .15s;flex-shrink:0}
.ibtn:hover{background:var(--s3);color:var(--tx)}

.msgs{flex:1;overflow-y:auto;padding:14px 14px;display:flex;flex-direction:column;gap:0;-webkit-overflow-scrolling:touch}
.daydiv{text-align:center;padding:10px 0;display:flex;align-items:center;gap:10px}
.daydiv::before,.daydiv::after{content:'';flex:1;height:1px;background:var(--bd)}
.daydiv span{font-size:10px;color:var(--mu);font-family:'JetBrains Mono',monospace;white-space:nowrap}

.mg{margin-bottom:10px}
.mrow{display:flex;align-items:flex-start;gap:8px}
.mrow.me{flex-direction:row-reverse}
.mmeta{display:flex;align-items:center;gap:7px;margin-bottom:4px}
.mrow.me .mmeta{flex-direction:row-reverse}
.malias{font-size:11.5px;font-weight:700;font-family:'JetBrains Mono',monospace}
.mtime{font-size:10px;color:var(--mu)}
.bubbles{display:flex;flex-direction:column;gap:3px;max-width:min(440px,75vw)}
.mrow.me .bubbles{align-items:flex-end}
.bubble-wrap{position:relative}
.bubble{padding:9px 13px;border-radius:4px 14px 14px 14px;background:var(--s2);border:1px solid var(--bd2);font-size:14px;line-height:1.6;word-break:break-word;width:fit-content;max-width:100%;position:relative}
.bubble.me{background:linear-gradient(135deg,#2a5bd6,var(--acc));border-color:transparent;border-radius:14px 4px 14px 14px;color:#fff}
.bubble img{max-width:100%;max-height:220px;border-radius:8px;display:block;cursor:zoom-in;margin-top:4px}
.mention{color:var(--acc3);font-weight:600;background:rgba(91,255,192,.09);border-radius:4px;padding:0 3px}
.mention.me-m{background:rgba(255,255,255,.15);color:#fff}
.sysmsg{text-align:center;font-size:11px;color:var(--mu);font-family:'JetBrains Mono',monospace;padding:5px 0}

/* delete msg btn */
.del-msg-btn{display:none;position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:#ff3a5c;border:none;color:#fff;cursor:pointer;font-size:10px;align-items:center;justify-content:center;z-index:5;line-height:1}
.bubble-wrap:hover .del-msg-btn{display:flex}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.inp-wrap{
  padding:10px 12px;
  background:var(--s1);
  border-top:1px solid var(--bd);
  flex-shrink:0;
  position:relative;
  z-index:10}
.mention-dd{background:var(--s2);border:1px solid var(--bd2);border-radius:10px;margin-bottom:8px;overflow:hidden;display:none;max-height:160px;overflow-y:auto}
.mdd-item{padding:9px 12px;cursor:pointer;display:flex;align-items:center;gap:9px;font-size:13px;transition:background .1s}
.mdd-item:hover,.mdd-item.sel{background:var(--s3)}
.mdd-item .av{width:22px;height:22px;font-size:9px}
.inp-row{display:flex;align-items:flex-end;gap:8px}
.act-btn{width:40px;height:40px;border-radius:9px;border:1px solid var(--bd2);background:var(--s2);color:var(--mu2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .15s;flex-shrink:0;min-height:40px}
.act-btn:hover{background:var(--s3);color:var(--acc);border-color:var(--acc)}
#file-in{display:none}
.ibox{
  flex:1;background:var(--s2);border:1px solid var(--bd2);
  border-radius:11px;padding:10px 13px;
  color:var(--tx);font-family:'Outfit',sans-serif;font-size:15px;
  outline:none;resize:none;
  max-height:120px;min-height:40px;
  line-height:1.5;
  transition:border-color .2s,box-shadow .2s;
  -webkit-appearance:none;appearance:none;
  display:block;width:100%}
.ibox:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(91,143,255,.1)}
.sbtn{width:40px;height:40px;border-radius:9px;border:none;background:linear-gradient(135deg,var(--acc),#2d66e0);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;transition:opacity .2s,transform .1s;box-shadow:0 2px 12px rgba(91,143,255,.32);min-height:40px}
.sbtn:hover{opacity:.9}
.sbtn:active{transform:scale(.93)}
.img-strip{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.ithumb{position:relative}
.ithumb img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid var(--bd2)}
.ithumb button{position:absolute;top:-5px;right:-5px;width:18px;height:18px;border-radius:50%;background:#ff3a5c;border:none;color:#fff;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;line-height:1}

.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--mu);gap:12px}
.empty .em{font-size:52px}
.empty p{font-size:14px;text-align:center;max-width:230px;line-height:1.6}

/* ‚îÄ‚îÄ OVERLAY / MODALS ‚îÄ‚îÄ */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);animation:fi .2s;padding:0}
@media(min-width:500px){.ov{align-items:center;padding:16px}}
@keyframes fi{from{opacity:0}to{opacity:1}}
.modal{background:var(--s1);border:1px solid var(--bd2);border-radius:18px 18px 0 0;padding:24px 22px;width:100%;max-width:400px;box-shadow:0 24px 60px rgba(0,0,0,.5);animation:slideUp .35s cubic-bezier(.16,1,.3,1);max-height:90vh;overflow-y:auto}
@media(min-width:500px){.modal{border-radius:18px;animation:rise .35s cubic-bezier(.16,1,.3,1)}}
@keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:none}}
.modal h3{font-size:17px;font-weight:700;margin-bottom:5px}
.modal .sub2{font-size:13px;color:var(--mu2);margin-bottom:18px;line-height:1.5}
.mbtns{display:flex;gap:9px;margin-top:16px;flex-wrap:wrap}
.mbtns .btn{margin-top:0}
.lock-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,200,91,.1);border:1px solid rgba(255,200,91,.2);border-radius:8px;padding:6px 12px;font-size:12px;color:var(--warn);font-family:'JetBrains Mono',monospace;margin-bottom:13px}

/* profile modal */
.profile-av-wrap{position:relative;width:fit-content;margin:0 auto 16px}
.profile-av-wrap .av.lg{cursor:pointer}
.av-edit-badge{position:absolute;bottom:0;right:0;width:22px;height:22px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;border:2px solid var(--s1)}
#av-file-in{display:none}

/* username badge */
.uname-badge{background:rgba(91,143,255,.1);border:1px solid rgba(91,143,255,.2);border-radius:6px;padding:2px 8px;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--acc);display:inline-block;margin-top:4px}

/* lightbox */
.lb{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:200;display:flex;align-items:center;justify-content:center;cursor:zoom-out;padding:16px}
.lb img{max-width:100%;max-height:90vh;border-radius:10px;object-fit:contain}

/* toast */
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--s2);border:1px solid var(--bd2);border-radius:10px;padding:9px 18px;font-size:13px;z-index:300;opacity:0;transition:all .28s;pointer-events:none;white-space:nowrap;box-shadow:0 8px 28px rgba(0,0,0,.4)}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* swipe overlay for mobile */
.sb-backdrop{display:none;position:fixed;inset:0;z-index:49;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}

/* ‚îÄ‚îÄ MOBILE RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:700px){
  :root{--sb-w:80vw}
  .sb{
    position:fixed;top:0;left:0;height:100%;z-index:50;
    transform:translateX(-100%);
    box-shadow:8px 0 32px rgba(0,0,0,.5)}
  .sb.open{transform:translateX(0)}
  .sb-backdrop.visible{display:block}
  .chat{width:100vw}
  .bubbles{max-width:78vw}
  .ch-head{padding:10px 12px}
  .msgs{padding:12px 10px}
  .inp-wrap{padding:8px 10px}
}

/* hamburger */
.ham{display:none;width:36px;height:36px;border-radius:8px;border:1px solid var(--bd2);background:var(--s2);color:var(--tx);cursor:pointer;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
@media(max-width:700px){.ham{display:flex}}
</style>
</head>
<body>
<div class="bg-noise"></div>
<div class="glow g1"></div>
<div class="glow g2"></div>

<!-- LOGIN -->
<div class="screen" id="s-login">
  <div class="card">
    <div class="brand"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Sign in</h1>
    <p class="sub">Use your school email to access the community.</p>
    <button class="btn google" onclick="doGoogle()">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
      Continue with Google
    </button>
    <div class="divider">or sign in with email</div>
    <div class="field"><label>Email</label><input id="l-email" type="email" placeholder="you@school.edu" autocomplete="email"></div>
    <div class="field"><label>Password</label><input id="l-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
    <div class="err" id="l-err"></div>
    <button class="btn" onclick="doLogin()">Sign In</button>
    <div class="lnk">New here? <a onclick="showS('s-reg')">Create account</a></div>
  </div>
</div>

<!-- REGISTER -->
<div class="screen gone" id="s-reg">
  <div class="card">
    <div class="brand"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Create account</h1>
    <p class="sub">Sign up with your school email address.</p>
    <button class="btn google" onclick="doGoogle()">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
      Sign up with Google
    </button>
    <div class="divider">or create with email</div>
    <div class="field"><label>Email</label><input id="r-email" type="email" placeholder="you@school.edu" autocomplete="email"></div>
    <div class="field"><label>Password</label><input id="r-pass" type="password" placeholder="min 6 characters" autocomplete="new-password"></div>
    <div class="field"><label>Confirm Password</label><input id="r-pass2" type="password" placeholder="repeat password" autocomplete="new-password"></div>
    <div class="err" id="r-err"></div>
    <button class="btn" onclick="doRegister()">Create Account</button>
    <div class="lnk">Already a member? <a onclick="showS('s-login')">Sign in</a></div>
  </div>
</div>

<!-- ALIAS SETUP -->
<div class="screen gone" id="s-alias">
  <div class="card">
    <div class="brand"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Set up your profile</h1>
    <p class="sub">Choose a unique username ‚Äî this is your identity in the community.</p>
    <div class="alias-tip">üé≠ Your real identity stays private ‚Äî only your alias is visible.</div>
    <div class="username-tip">‚ö° Username must be unique ‚Äî no one else can have the same name.</div>
    <div class="field">
      <label>Username / Alias</label>
      <input id="a-name" type="text" placeholder="e.g. NeonWave, CosmicPanda‚Ä¶" maxlength="20" autocomplete="off">
      <div class="err" id="a-err" style="display:block;color:var(--mu2)">3‚Äì20 characters, letters/numbers/_ only</div>
    </div>
    <div class="field"><label>Pick a color</label><div class="col-row" id="col-row"></div></div>
    <button class="btn" onclick="saveAlias()">Continue ‚Üí</button>
  </div>
</div>

<!-- GUIDELINES -->
<div class="screen gone" id="s-warn">
  <div class="card">
    <div class="warn-em">‚ö†Ô∏è</div>
    <div class="brand" style="margin-bottom:4px"><div class="brand-dot"></div><div class="brand-tag">MISC Station</div></div>
    <h1>Community Rules</h1>
    <div class="warn-box"><p>Anonymity is a privilege ‚Äî not a license to harm. Be the community you want to be part of.</p></div>
    <ul class="rules">
      <li><span class="rdot"></span>Be respectful and kind to every member at all times.</li>
      <li><span class="rdot"></span>Zero tolerance for hate speech, bullying, or discrimination.</li>
      <li><span class="rdot"></span>Do not spread false rumors or expose others' private info.</li>
      <li><span class="rdot"></span>No explicit, violent, or inappropriate content of any kind.</li>
      <li><span class="rdot"></span>Violations result in immediate and permanent ban.</li>
    </ul>
    <label class="agree-row"><input type="checkbox" id="agree-cb"> I understand and will follow these rules.</label>
    <button class="btn" onclick="enterApp()">Enter MISC Station</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="gone">
  <div class="sb-backdrop" id="sb-backdrop" onclick="closeSb()"></div>
  <!-- SIDEBAR -->
  <div class="sb" id="sb">
    <div class="sb-top">
      <div class="sb-logo">MISC Station<small>school ¬∑ anonymous</small></div>
      <div class="upill" id="upill" onclick="openProfile()">
        <div class="av" id="sb-av"></div>
        <span id="sb-name"></span>
      </div>
    </div>
    <div class="sb-search"><input id="room-q" placeholder="üîç  Search rooms‚Ä¶" oninput="filterRooms(this.value)"></div>
    <div class="sb-sec">Channels <button onclick="openCreate()" title="New Room">Ôºã</button></div>
    <div class="rlist" id="rlist"></div>
    <div class="sb-foot">
      <div class="sb-btn" onclick="doLogout()">‚Ü© &nbsp;Sign out</div>
    </div>
  </div>
  <!-- CHAT -->
  <div class="chat" id="chat">
    <div class="empty" id="empty-state">
      <div class="em">üí¨</div>
      <p>Pick a channel from the sidebar to start chatting.</p>
    </div>
  </div>
</div>

<!-- MODAL: create room -->
<div class="ov gone" id="m-create">
  <div class="modal">
    <h3>Create a Room</h3>
    <p class="sub2">Public rooms are open to all. Private rooms need a password.</p>
    <div class="field"><label>Room Name</label><input id="cr-n" type="text" placeholder="e.g. Study Group, Art Club‚Ä¶" maxlength="30"></div>
    <div class="field"><label>Icon (emoji)</label><input id="cr-i" type="text" placeholder="üé®" maxlength="2" style="width:70px"></div>
    <div class="field"><label>Description</label><input id="cr-d" type="text" placeholder="What's this room about?" maxlength="60"></div>
    <div class="field"><label>Room Type</label>
      <select id="cr-t" onchange="togglePw()">
        <option value="public">üåê Public ‚Äî anyone can join</option>
        <option value="private">üîí Private ‚Äî password required</option>
      </select>
    </div>
    <div class="field gone" id="cr-pw-f"><label>Room Password</label><input id="cr-pw" type="text" placeholder="Set join password"></div>
    <div class="err" id="cr-err"></div>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-create')">Cancel</button>
      <button class="btn" onclick="createRoom()">Create Room</button>
    </div>
  </div>
</div>

<!-- MODAL: join private -->
<div class="ov gone" id="m-join">
  <div class="modal">
    <h3>üîí Private Room</h3>
    <p class="sub2">This room requires a password set by the admin.</p>
    <div class="lock-badge">üîë Password protected</div>
    <div class="field"><label>Password</label><input id="jp-pw" type="password" placeholder="Enter room password"></div>
    <div class="err" id="jp-err">Incorrect password. Try again.</div>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-join')">Cancel</button>
      <button class="btn" onclick="joinRoom()">Join Room</button>
    </div>
  </div>
</div>

<!-- MODAL: room settings -->
<div class="ov gone" id="m-settings">
  <div class="modal">
    <h3>‚öôÔ∏è Room Settings</h3>
    <p class="sub2" id="rs-rname"></p>
    <div class="field"><label>Room Name</label><input id="rs-n" type="text"></div>
    <div class="field"><label>Description</label><input id="rs-d" type="text"></div>
    <div class="field"><label>Password (blank = public)</label><input id="rs-pw" type="text" placeholder="New password or leave blank"></div>
    <div class="err" id="rs-err"></div>
    <div class="mbtns">
      <button class="btn red sm" onclick="deleteRoom()">üóë Delete</button>
      <div style="flex:1"></div>
      <button class="btn ghost sm" onclick="closeM('m-settings')">Cancel</button>
      <button class="btn sm" onclick="saveRoomSettings()">Save</button>
    </div>
  </div>
</div>

<!-- MODAL: profile -->
<div class="ov gone" id="m-profile">
  <div class="modal" style="text-align:center">
    <div class="profile-av-wrap">
      <div class="av lg" id="pav"></div>
      <div class="av-edit-badge" onclick="g('av-file-in').click()">üì∑</div>
      <input type="file" id="av-file-in" accept="image/*" onchange="uploadAvatar(this.files[0])">
    </div>
    <h3 id="pname"></h3>
    <div id="p-uname-badge" class="uname-badge"></div>
    <p class="sub2" id="pemail" style="margin-top:6px"></p>
    <div class="field" style="text-align:left">
      <label>Change Alias / Username</label>
      <input id="p-alias" type="text" maxlength="20" autocomplete="off">
      <div class="err" id="p-alias-err"></div>
    </div>
    <div class="field" style="text-align:left"><label>Change Color</label><div class="col-row" id="p-colors"></div></div>
    <div class="mbtns">
      <button class="btn ghost" onclick="closeM('m-profile')">Cancel</button>
      <button class="btn" onclick="saveProfile()">Save Changes</button>
    </div>
  </div>
</div>

<!-- lightbox -->
<div class="lb gone" id="lb" onclick="this.classList.add('gone')"><img id="lb-img" alt=""></div>
<!-- toast -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ globals ‚îÄ‚îÄ
let fb, CU, CP, CR, CRD;
let unsubM=null, unsubR=null;
let allUsers={};
let pendImgs=[];
let joinTarget=null;
let mentionActive=false, mentionQuery='', mentionIdx=0;
let lastRooms=[];
let touchStartX=0, touchStartY=0;

const COLORS=['#5b8fff','#ff5b8f','#5bffc0','#ffc85b','#c05bff','#ff8c5b','#5beaff','#ff5b5b'];
let selColor=COLORS[0];
let profColor=COLORS[0];

const DEFAULT_ROOMS=[
  {id:'general',   name:'General',       icon:'üè´', desc:'School-wide chat',        type:'public',adminUid:null},
  {id:'homework',  name:'Homework Help',  icon:'üìö', desc:'Get help with homework',  type:'public',adminUid:null},
  {id:'memes',     name:'Memes & Fun',    icon:'üòÇ', desc:'Laugh a little',          type:'public',adminUid:null},
  {id:'events',    name:'Events',         icon:'üéâ', desc:'Events & plans',          type:'public',adminUid:null},
  {id:'sports',    name:'Sports',         icon:'‚öΩ', desc:'Sports talk',             type:'public',adminUid:null},
  {id:'advice',    name:'Advice Box',     icon:'üí≠', desc:'Anonymous advice',        type:'public',adminUid:null},
];

window.addEventListener('firebase-ready',()=>{
  fb=window._fb;
  buildColPicker('col-row',c=>selColor=c);
  seedDefaults();
  fb.onAuthStateChanged(fb.auth,async u=>{
    if(u){
      CU=u;
      const snap=await fb.getDoc(fb.doc(fb.db,'users',u.uid));
      if(snap.exists()&&snap.data().alias){CP=snap.data();showS('s-warn');}
      else{
        // pre-fill from Google
        if(u.displayName) g('a-name').value=u.displayName.replace(/\s+/g,'').slice(0,20);
        showS('s-alias');
      }
    } else {CU=null;CP=null;showS('s-login');}
  });
  initSwipe();
});

// ‚îÄ‚îÄ swipe sidebar ‚îÄ‚îÄ
function initSwipe(){
  document.addEventListener('touchstart',e=>{
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
  },{passive:true});
  document.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-touchStartX;
    const dy=Math.abs(e.changedTouches[0].clientY-touchStartY);
    if(dy>60) return; // vertical swipe, ignore
    if(dx>60&&touchStartX<40) openSb();   // swipe right from left edge
    if(dx<-60) closeSb();                  // swipe left
  },{passive:true});
}

function openSb(){
  g('sb').classList.add('open');
  g('sb-backdrop').classList.add('visible');
}
function closeSb(){
  g('sb').classList.remove('open');
  g('sb-backdrop').classList.remove('visible');
}

// ‚îÄ‚îÄ screen ‚îÄ‚îÄ
function showS(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('gone'));
  g(id)?.classList.remove('gone');
}

// ‚îÄ‚îÄ auth ‚îÄ‚îÄ
async function doLogin(){
  try{await fb.signInWithEmailAndPassword(fb.auth,v('l-email'),v('l-pass'));}
  catch(e){showErr('l-err',fe(e.code));}
}
async function doRegister(){
  const p=v('r-pass'),p2=v('r-pass2');
  if(p!==p2) return showErr('r-err','Passwords do not match.');
  if(p.length<6) return showErr('r-err','Password must be at least 6 characters.');
  try{await fb.createUserWithEmailAndPassword(fb.auth,v('r-email'),p);}
  catch(e){showErr('r-err',fe(e.code));}
}
async function doGoogle(){
  try{
    const provider=new fb.GoogleAuthProvider();
    await fb.signInWithPopup(fb.auth,provider);
    // onAuthStateChanged handles the rest
  }catch(e){toast(fe(e.code));}
}

async function saveAlias(){
  const name=v('a-name');
  if(!/^[\w]{3,20}$/.test(name)) return showErr('a-err','3‚Äì20 characters, letters/numbers/_ only.');
  // check uniqueness
  const q=fb.query(fb.collection(fb.db,'users'),fb.where('alias','==',name));
  const snap=await fb.getDocs(q);
  if(!snap.empty&&snap.docs[0].id!==CU.uid) return showErr('a-err','Username already taken. Choose another.');
  const profile={alias:name,color:selColor,email:CU.email||'',uid:CU.uid,photoURL:CU.photoURL||''};
  await fb.setDoc(fb.doc(fb.db,'users',CU.uid),profile);
  CP=profile;showS('s-warn');
}
function enterApp(){
  if(!g('agree-cb').checked) return toast('Please agree to the community rules.');
  launchApp();
}
async function doLogout(){
  if(unsubM)unsubM();
  if(unsubR)unsubR();
  CR=null;CRD=null;
  await fb.signOut(fb.auth);
}

// ‚îÄ‚îÄ app ‚îÄ‚îÄ
async function launchApp(){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('gone'));
  g('app').classList.remove('gone');
  updatePill();
  startRoomSub();
  await loadUsers();
}
function updatePill(){
  const av=g('sb-av');
  if(CP.photoURL){av.innerHTML=`<img src="${CP.photoURL}" alt="">`;}
  else{av.textContent=CP.alias[0].toUpperCase();av.style.background=CP.color;}
  g('sb-name').textContent=CP.alias;
}
async function loadUsers(){
  const snap=await fb.getDocs(fb.collection(fb.db,'users'));
  snap.forEach(d=>allUsers[d.id]=d.data());
}

// ‚îÄ‚îÄ seed ‚îÄ‚îÄ
async function seedDefaults(){
  for(const r of DEFAULT_ROOMS){
    const ref=fb.doc(fb.db,'rooms',r.id);
    const s=await fb.getDoc(ref);
    if(!s.exists()) await fb.setDoc(ref,{...r,createdAt:fb.serverTimestamp()});
  }
}

// ‚îÄ‚îÄ rooms ‚îÄ‚îÄ
function startRoomSub(){
  const q=fb.query(fb.collection(fb.db,'rooms'),fb.orderBy('createdAt','asc'));
  unsubR=fb.onSnapshot(q,snap=>{
    lastRooms=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderRooms(lastRooms);
  });
}
function renderRooms(rooms){
  const list=g('rlist');list.innerHTML='';
  rooms.forEach(r=>{
    const div=document.createElement('div');
    div.className='ri'+(CR===r.id?' active':'');
    div.dataset.id=r.id;
    div.innerHTML=`
      <div class="ri-ico" style="background:${rbg(r.id)}">${r.icon||'#'}</div>
      <div class="ri-info">
        <div class="ri-name">${esc(r.name)} ${r.type==='private'?'<span class="lock">üîí</span>':''}</div>
        <div class="ri-prev">${esc(r.desc||'')}</div>
      </div>`;
    div.onclick=()=>{tryJoin(r);closeSb();};
    list.appendChild(div);
  });
}
function filterRooms(q){
  renderRooms(q?lastRooms.filter(r=>r.name.toLowerCase().includes(q.toLowerCase())):lastRooms);
}

// ‚îÄ‚îÄ join ‚îÄ‚îÄ
async function tryJoin(r){
  if(r.type==='private'){
    if(r.adminUid===CU?.uid){openRoom(r);return;}
    const memSnap=await fb.getDoc(fb.doc(fb.db,'rooms',r.id,'members',CU.uid));
    if(!memSnap.exists()){joinTarget=r;g('jp-pw').value='';g('jp-err').style.display='none';openM('m-join');return;}
  }
  openRoom(r);
}
async function joinRoom(){
  if(v('jp-pw')!==joinTarget.password){g('jp-err').style.display='block';return;}
  await fb.setDoc(fb.doc(fb.db,'rooms',joinTarget.id,'members',CU.uid),{joinedAt:fb.serverTimestamp()});
  closeM('m-join');openRoom(joinTarget);joinTarget=null;
}

// ‚îÄ‚îÄ open room ‚îÄ‚îÄ
function openRoom(r){
  CR=r.id;CRD=r;
  if(unsubM)unsubM();
  document.querySelectorAll('.ri').forEach(x=>x.classList.toggle('active',x.dataset.id===r.id));
  renderChat(r);
  startMsgSub(r.id);
}

function renderChat(r){
  const isAdmin=r.adminUid===CU?.uid;
  g('chat').innerHTML=`
    <div class="ch-head">
      <button class="ham" onclick="openSb()">‚ò∞</button>
      <div class="ch-ico" style="background:${rbg(r.id)}">${r.icon||'#'}</div>
      <div class="ch-info" style="flex:1;min-width:0">
        <h2>${esc(r.name)} ${r.type==='private'?'üîí':''}</h2>
        <p><span class="online"></span>${esc(r.desc||'')} ¬∑ anonymous</p>
      </div>
      <div class="ch-acts">${isAdmin?`<button class="ibtn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>`:''}</div>
    </div>
    <div class="msgs" id="mlist"></div>
    <div class="inp-wrap">
      <div class="img-strip" id="img-strip"></div>
      <div class="mention-dd" id="mdd"></div>
      <div class="inp-row">
        <button class="act-btn" onclick="g('file-in').click()" title="Upload Image">üñº</button>
        <input type="file" id="file-in" accept="image/*" multiple onchange="handleImgs(this.files)">
        <textarea class="ibox" id="ibox" placeholder="Message #${r.name.toLowerCase()}‚Ä¶ (@ to mention)"
          rows="1" onkeydown="hKey(event)" oninput="hInput(this)"></textarea>
        <button class="sbtn" onclick="sendMsg()">‚û§</button>
      </div>
    </div>`;

  // Focus fix ‚Äî clicking anywhere in inp-wrap focuses textarea
  const wrap=g('chat').querySelector('.inp-wrap');
  wrap.addEventListener('click',e=>{
    if(!e.target.closest('button')&&!e.target.closest('#file-in')&&!e.target.closest('.mdd-item')){
      g('ibox')?.focus();
    }
  });
}

// ‚îÄ‚îÄ messages ‚îÄ‚îÄ
function startMsgSub(rid){
  const q=fb.query(fb.collection(fb.db,'rooms',rid,'messages'),fb.orderBy('ts','asc'));
  unsubM=fb.onSnapshot(q,snap=>renderMsgs(snap.docs.map(d=>({id:d.id,...d.data()}))));
}

function renderMsgs(msgs){
  const list=g('mlist');if(!list)return;
  const wasAtBottom=list.scrollHeight-list.scrollTop-list.clientHeight<80;
  list.innerHTML='';
  let lastDate='',lastUid='';
  msgs.forEach(m=>{
    const d=m.ts?new Date(m.ts.seconds*1000):new Date();
    const dateStr=d.toLocaleDateString([],{weekday:'short',month:'short',day:'numeric'});
    if(dateStr!==lastDate){
      const dd=document.createElement('div');dd.className='daydiv';
      dd.innerHTML=`<span>${dateStr}</span>`;list.appendChild(dd);
      lastDate=dateStr;lastUid='';
    }
    if(m.type==='system'){
      const s=document.createElement('div');s.className='sysmsg';s.textContent=m.text;list.appendChild(s);return;
    }
    const isMine=m.uid===CU.uid;
    const newGrp=m.uid!==lastUid;lastUid=m.uid;
    if(newGrp){
      const mg=document.createElement('div');mg.className='mg';
      const row=document.createElement('div');row.className='mrow'+(isMine?' me':'');
      const av=document.createElement('div');av.className='av';
      if(m.photoURL){av.innerHTML=`<img src="${m.photoURL}" alt="">`;}
      else{av.style.background=m.color;av.textContent=(m.alias||'?')[0].toUpperCase();}
      const side=document.createElement('div');side.style.cssText='flex:1;display:flex;flex-direction:column;min-width:0'+(isMine?';align-items:flex-end':'');
      const meta=document.createElement('div');meta.className='mmeta';
      meta.innerHTML=`<span class="malias" style="color:${m.color}">${esc(m.alias)}</span><span class="mtime">${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
      const bubbles=document.createElement('div');bubbles.className='bubbles';
      bubbles.appendChild(mkBubble(m,isMine));
      side.appendChild(meta);side.appendChild(bubbles);
      row.appendChild(av);row.appendChild(side);
      mg.appendChild(row);list.appendChild(mg);
    } else {
      const bubbles=list.lastElementChild?.querySelector('.bubbles');
      if(bubbles) bubbles.appendChild(mkBubble(m,isMine));
    }
  });
  if(wasAtBottom) list.scrollTop=list.scrollHeight;
}

function mkBubble(m,isMine){
  const wrap=document.createElement('div');wrap.className='bubble-wrap';
  const b=document.createElement('div');b.className='bubble'+(isMine?' me':'');
  if(m.imageUrl){
    const img=document.createElement('img');img.src=m.imageUrl;img.alt='';
    img.onclick=()=>{g('lb-img').src=m.imageUrl;g('lb').classList.remove('gone');};
    b.appendChild(img);
  }
  if(m.text){
    const span=document.createElement('span');
    span.innerHTML=fmtText(m.text,isMine);
    b.appendChild(span);
  }
  wrap.appendChild(b);
  // delete button ‚Äî only for own messages
  if(isMine){
    const del=document.createElement('button');
    del.className='del-msg-btn';del.title='Delete';del.innerHTML='‚úï';
    del.onclick=e=>{e.stopPropagation();deleteMsg(m.id);};
    wrap.appendChild(del);
  }
  return wrap;
}

async function deleteMsg(msgId){
  if(!CR)return;
  await fb.deleteDoc(fb.doc(fb.db,'rooms',CR,'messages',msgId));
}

function fmtText(text,isMine){
  return esc(text).replace(/@(\w+)/g,(_,n)=>`<span class="mention${isMine?' me-m':''}">@${n}</span>`);
}

// ‚îÄ‚îÄ send ‚îÄ‚îÄ
async function sendMsg(){
  const inp=g('ibox');if(!inp)return;
  const text=inp.value.trim();
  if(!text&&!pendImgs.length)return;
  inp.value='';inp.style.height='auto';
  const base={uid:CU.uid,alias:CP.alias,color:CP.color,photoURL:CP.photoURL||'',ts:fb.serverTimestamp()};
  const toSend=[...pendImgs];pendImgs=[];g('img-strip').innerHTML='';
  for(const file of toSend){
    try{
      const r=fb.ref(fb.storage,`msgs/${CR}/${Date.now()}_${file.name}`);
      const s=await fb.uploadBytes(r,file);
      const url=await fb.getDownloadURL(s.ref);
      await fb.addDoc(fb.collection(fb.db,'rooms',CR,'messages'),{...base,imageUrl:url,text:''});
    }catch(e){toast('Image upload failed. Check Storage rules.');}
  }
  if(text) await fb.addDoc(fb.collection(fb.db,'rooms',CR,'messages'),{...base,text});
  inp.focus();
}

// ‚îÄ‚îÄ key / input ‚îÄ‚îÄ
function hKey(e){
  if(mentionActive){
    if(e.key==='ArrowDown'){mentionIdx++;renderMDD();e.preventDefault();return}
    if(e.key==='ArrowUp'){mentionIdx=Math.max(0,mentionIdx-1);renderMDD();e.preventDefault();return}
    if(e.key==='Enter'||e.key==='Tab'){selMention();e.preventDefault();return}
    if(e.key==='Escape'){closeMDD();return}
  }
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();return}
  autoH(e.target);
}
function hInput(inp){
  autoH(inp);
  const before=inp.value.slice(0,inp.selectionStart);
  const m=before.match(/@(\w*)$/);
  if(m){mentionQuery=m[1].toLowerCase();mentionActive=true;mentionIdx=0;renderMDD();}
  else closeMDD();
}
function autoH(inp){inp.style.height='auto';inp.style.height=Math.min(inp.scrollHeight,120)+'px'}

function getMCands(){
  return Object.values(allUsers).filter(u=>u.uid!==CU.uid&&(!mentionQuery||u.alias.toLowerCase().includes(mentionQuery))).slice(0,6);
}
function renderMDD(){
  const box=g('mdd');if(!box)return;
  const cands=getMCands();
  if(!cands.length){closeMDD();return}
  box.style.display='block';box.innerHTML='';
  cands.forEach((u,i)=>{
    const it=document.createElement('div');it.className='mdd-item'+(i===mentionIdx%cands.length?' sel':'');
    const av=document.createElement('div');av.className='av';av.style.cssText='width:22px;height:22px;font-size:9px';
    if(u.photoURL)av.innerHTML=`<img src="${u.photoURL}" alt="">`;
    else{av.style.background=u.color;av.textContent=u.alias[0].toUpperCase();}
    it.appendChild(av);
    const nm=document.createElement('span');nm.textContent=u.alias;it.appendChild(nm);
    it.onclick=()=>{mentionIdx=i;selMention();};
    box.appendChild(it);
  });
}
function selMention(){
  const cands=getMCands();if(!cands.length)return;
  const chosen=cands[mentionIdx%cands.length];
  const inp=g('ibox');
  const before=inp.value.slice(0,inp.selectionStart).replace(/@\w*$/,'');
  inp.value=before+'@'+chosen.alias+' '+inp.value.slice(inp.selectionStart);
  inp.focus();closeMDD();
}
function closeMDD(){mentionActive=false;const b=g('mdd');if(b)b.style.display='none';}

// ‚îÄ‚îÄ images ‚îÄ‚îÄ
function handleImgs(files){
  Array.from(files).forEach(file=>{
    if(!file.type.startsWith('image/'))return;
    pendImgs.push(file);
    const fr=new FileReader();
    fr.onload=e=>{
      const strip=g('img-strip');
      const idx=pendImgs.indexOf(file);
      const th=document.createElement('div');th.className='ithumb';
      th.innerHTML=`<img src="${e.target.result}" alt=""><button onclick="rmImg(this,${pendImgs.indexOf(file)})">‚úï</button>`;
      strip.appendChild(th);
    };
    fr.readAsDataURL(file);
  });
  g('file-in').value='';
}
function rmImg(btn,i){
  if(i>=0&&i<pendImgs.length)pendImgs.splice(i,1);
  btn.parentElement.remove();
}

// ‚îÄ‚îÄ create room ‚îÄ‚îÄ
function openCreate(){openM('m-create');}
function togglePw(){g('cr-pw-f').classList.toggle('gone',g('cr-t').value!=='private');}
async function createRoom(){
  const name=v('cr-n');if(name.length<2)return showErr('cr-err','Name must be 2+ characters.');
  const type=g('cr-t').value,pw=v('cr-pw');
  if(type==='private'&&!pw)return showErr('cr-err','Set a password for private rooms.');
  const data={name,icon:v('cr-i')||'üí¨',desc:v('cr-d'),type,adminUid:CU.uid,adminAlias:CP.alias,createdAt:fb.serverTimestamp()};
  if(type==='private')data.password=pw;
  const ref=await fb.addDoc(fb.collection(fb.db,'rooms'),data);
  await fb.setDoc(fb.doc(fb.db,'rooms',ref.id,'members',CU.uid),{joinedAt:fb.serverTimestamp()});
  await fb.addDoc(fb.collection(fb.db,'rooms',ref.id,'messages'),{type:'system',text:`Room created by ${CP.alias}`,ts:fb.serverTimestamp()});
  closeM('m-create');toast(`Room "${name}" created!`);
  ['cr-n','cr-i','cr-d'].forEach(id=>{const el=g(id);if(el)el.value='';});
}

// ‚îÄ‚îÄ room settings ‚îÄ‚îÄ
function openSettings(){
  g('rs-rname').textContent=`#${CRD.name}`;g('rs-n').value=CRD.name;
  g('rs-d').value=CRD.desc||'';g('rs-pw').value='';
  openM('m-settings');
}
async function saveRoomSettings(){
  const name=v('rs-n');if(!name)return showErr('rs-err','Name cannot be empty.');
  const upd={name,desc:v('rs-d')};
  const pw=v('rs-pw');
  if(pw){upd.password=pw;upd.type='private';}
  else if(CRD.type==='private'){upd.type='public';}
  await fb.updateDoc(fb.doc(fb.db,'rooms',CR),upd);
  closeM('m-settings');toast('Settings saved!');
}
async function deleteRoom(){
  if(!confirm(`Delete "${CRD.name}"? This cannot be undone.`))return;
  const roomId=CR;
  // unsub first
  if(unsubM){unsubM();unsubM=null;}
  CR=null;CRD=null;
  // Reset chat to empty state BEFORE deleting
  g('chat').innerHTML=`
    <div style="display:flex;flex-direction:column;height:100vh;background:var(--bg)">
      <div class="ch-head" style="min-height:58px">
        <button class="ham" onclick="openSb()">‚ò∞</button>
        <div style="color:var(--mu2);font-size:14px">Room deleted</div>
      </div>
      <div class="empty">
        <div class="em">üí¨</div>
        <p>Room deleted. Select another channel.</p>
      </div>
    </div>`;
  document.querySelectorAll('.ri').forEach(x=>x.classList.remove('active'));
  closeM('m-settings');
  await fb.deleteDoc(fb.doc(fb.db,'rooms',roomId));
  toast('Room deleted.');
}

// ‚îÄ‚îÄ profile ‚îÄ‚îÄ
function openProfile(){
  const av=g('pav');
  if(CP.photoURL){av.innerHTML=`<img src="${CP.photoURL}" alt="">`;av.style.background='';}
  else{av.innerHTML='';av.textContent=CP.alias[0].toUpperCase();av.style.background=CP.color;}
  g('pname').textContent=CP.alias;
  g('p-uname-badge').textContent='@'+CP.alias;
  g('pemail').textContent=CP.email||'';
  g('p-alias').value=CP.alias;
  g('p-alias-err').style.display='none';
  profColor=CP.color;
  buildColPicker('p-colors',c=>profColor=c,CP.color);
  openM('m-profile');
}

async function uploadAvatar(file){
  if(!file)return;
  toast('Uploading...');
  try{
    const r=fb.ref(fb.storage,`avatars/${CU.uid}`);
    const s=await fb.uploadBytes(r,file);
    const url=await fb.getDownloadURL(s.ref);
    CP.photoURL=url;
    const av=g('pav');
    av.innerHTML=`<img src="${url}" alt="">`;
    toast('Photo updated!');
  }catch(e){toast('Upload failed. Check Storage rules.');}
}

async function saveProfile(){
  const alias=v('p-alias');
  if(!/^[\w]{3,20}$/.test(alias)) return showErr('p-alias-err','3‚Äì20 chars, letters/numbers/_ only.');
  if(alias!==CP.alias){
    const q=fb.query(fb.collection(fb.db,'users'),fb.where('alias','==',alias));
    const snap=await fb.getDocs(q);
    if(!snap.empty&&snap.docs[0].id!==CU.uid) return showErr('p-alias-err','Username already taken.');
  }
  CP.alias=alias;CP.color=profColor;
  await fb.setDoc(fb.doc(fb.db,'users',CU.uid),CP);
  allUsers[CU.uid]=CP;updatePill();closeM('m-profile');toast('Profile updated!');
}

// ‚îÄ‚îÄ color picker ‚îÄ‚îÄ
function buildColPicker(containerId,onChange,active){
  const c=g(containerId);if(!c)return;c.innerHTML='';
  COLORS.forEach(col=>{
    const d=document.createElement('div');d.className='cdot'+(col===(active||selColor)?' on':'');
    d.style.background=col;
    d.onclick=()=>{c.querySelectorAll('.cdot').forEach(x=>x.classList.remove('on'));d.classList.add('on');onChange(col);};
    c.appendChild(d);
  });
}

// ‚îÄ‚îÄ modals ‚îÄ‚îÄ
function openM(id){g(id)?.classList.remove('gone');}
function closeM(id){g(id)?.classList.add('gone');}
document.querySelectorAll('.ov').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.add('gone');}));

// ‚îÄ‚îÄ utils ‚îÄ‚îÄ
function g(id){return document.getElementById(id);}
function v(id){return(g(id)?.value||'').trim();}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function showErr(id,msg){const e=g(id);if(e){e.textContent=msg;e.style.display='block';e.style.color='var(--acc2)';}}
function toast(msg,ms=2800){const t=g('toast');t.textContent=msg;t.classList.add('on');setTimeout(()=>t.classList.remove('on'),ms);}
function rbg(id){const h=[...(id||'x')].reduce((a,c)=>a+c.charCodeAt(0),0);return COLORS[h%COLORS.length]+'22';}
function fe(code){return({'auth/user-not-found':'No account with this email.','auth/wrong-password':'Wrong password.','auth/invalid-email':'Invalid email.','auth/email-already-in-use':'Email already registered.','auth/too-many-requests':'Too many attempts. Try later.','auth/invalid-credential':'Invalid email or password.','auth/popup-closed-by-user':'Sign-in was cancelled.','auth/popup-blocked':'Allow popups for this site.','auth/account-exists-with-different-credential':'Account exists with a different sign-in method.'}[code]||'Something went wrong.');}
</script>
</body>
</html>
